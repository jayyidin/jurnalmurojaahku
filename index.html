<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Murojaahku</title>
    
    <!-- Tailwind CSS untuk Desain -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel untuk membaca kode React di Browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- üö® ALARM DETEKTOR ERROR: Mencegah Layar Blank Putih üö® -->
    <script>
        window.addEventListener('error', function(e) {
            document.body.innerHTML = `
                <div style="padding: 40px; text-align: center; font-family: sans-serif; background-color: #fff1f2; min-height: 100vh;">
                    <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(225,29,72,0.2); display: inline-block; max-width: 90%;">
                        <h2 style="color: #e11d48; margin-top:0;">‚ö†Ô∏è Ups! Ada Kesalahan Kode</h2>
                        <p style="color: #475569; font-size: 14px;">Aplikasi tidak bisa dimuat karena ada kode yang terhapus/salah ketik.</p>
                        <p style="color: #334155; font-size: 12px; background: #f1f5f9; padding: 10px; border-radius: 8px; text-align: left;"><strong>Detail Error:</strong><br/>${e.message}</p>
                        <button onclick="localStorage.clear(); sessionStorage.clear(); window.location.reload();" style="margin-top: 15px; background-color: #e11d48; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">Pulihkan Aplikasi</button>
                    </div>
                </div>
            `;
        });
    </script>
    
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a1a1aa; }
        body { 
            background-color: #fff7ed; 
            -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; 
        }
        input, textarea, select {
            -webkit-user-select: auto; -moz-user-select: auto; -ms-user-select: auto; user-select: auto;
        }
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; opacity: 0.6; transition: 0.2s; }
        input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }
    </style>

    <!-- Script Pelindung Website -->
    <script>
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.onkeydown = e => {
            if (event.keyCode == 123) return false;
            if (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0))) return false;
            if (e.ctrlKey && (e.keyCode == 'U'.charCodeAt(0) || e.keyCode == 'S'.charCodeAt(0) || e.keyCode == 'P'.charCodeAt(0))) return false;
        };
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { BookOpen, Check, Search, Calendar, Trash2, Trophy, Star, User, ChevronDown, Lock, LogOut, X, AlertTriangle, PlusCircle, UserCog, Pencil, FolderOpen, Edit2, Settings, Loader2, ArrowRight, ArrowLeft, Users, ArrowUp, ArrowDown, LayoutDashboard, Share2, Database, Medal, Download, Image as ImageIcon, Smartphone, Globe, BellRing, Megaphone, Send, Filter, Cloud, CloudOff } from 'https://esm.sh/lucide-react@0.263.1';
        import html2canvas from 'https://esm.sh/html2canvas';

        // --- DATA AWAL (Default) ---
        const INITIAL_DATA = [
          { id: "ust-1", name: "Ustadz Abdullah", gender: "male", halaqohs: [{ id: "h-1a", name: "Halaqoh Abu Bakar", students: ["Ahmad", "Fatih"] }] }
        ];

        const DEFAULT_CLASS_LIST = ["Kelas 1", "Kelas 2", "Kelas 3", "Kelas 4", "Kelas 5", "Kelas 6"];

        const SURAH_LIST = [{number:1,name:"Al-Fatihah",ayahs:7},{number:2,name:"Al-Baqarah",ayahs:286},{number:3,name:"Ali 'Imran",ayahs:200},{number:4,name:"An-Nisa'",ayahs:176},{number:5,name:"Al-Ma'idah",ayahs:120},{number:6,name:"Al-An'am",ayahs:165},{number:7,name:"Al-A'raf",ayahs:206},{number:8,name:"Al-Anfal",ayahs:75},{number:9,name:"At-Taubah",ayahs:129},{number:10,name:"Yunus",ayahs:109},{number:11,name:"Hud",ayahs:123},{number:12,name:"Yusuf",ayahs:111},{number:13,name:"Ar-Ra'd",ayahs:43},{number:14,name:"Ibrahim",ayahs:52},{number:15,name:"Al-Hijr",ayahs:99},{number:16,name:"An-Nahl",ayahs:128},{number:17,name:"Al-Isra'",ayahs:111},{number:18,name:"Al-Kahf",ayahs:110},{number:19,name:"Maryam",ayahs:98},{number:20,name:"Ta-Ha",ayahs:135},{number:21,name:"Al-Anbiya'",ayahs:112},{number:22,name:"Al-Hajj",ayahs:78},{number:23,name:"Al-Mu'minun",ayahs:118},{number:24,name:"An-Nur",ayahs:64},{number:25,name:"Al-Furqan",ayahs:77},{number:26,name:"Asy-Syu'ara'",ayahs:227},{number:27,name:"An-Naml",ayahs:93},{number:28,name:"Al-Qasas",ayahs:88},{number:29,name:"Al-'Ankabut",ayahs:69},{number:30,name:"Ar-Rum",ayahs:60},{number:31,name:"Luqman",ayahs:34},{number:32,name:"As-Sajdah",ayahs:30},{number:33,name:"Al-Ahzab",ayahs:73},{number:34,name:"Saba'",ayahs:54},{number:35,name:"Fatir",ayahs:45},{number:36,name:"Ya-Sin",ayahs:83},{number:37,name:"As-Saffat",ayahs:182},{number:38,name:"Sad",ayahs:88},{number:39,name:"Az-Zumar",ayahs:75},{number:40,name:"Ghafir",ayahs:85},{number:41,name:"Fussilat",ayahs:54},{number:42,name:"Asy-Syura",ayahs:53},{number:43,name:"Az-Zukhruf",ayahs:89},{number:44,name:"Ad-Dukhan",ayahs:59},{number:45,name:"Al-Jasiyah",ayahs:37},{number:46,name:"Al-Ahqaf",ayahs:35},{number:47,name:"Muhammad",ayahs:38},{number:48,name:"Al-Fath",ayahs:29},{number:49,name:"Al-Hujurat",ayahs:18},{number:50,name:"Qaf",ayahs:45},{number:51,name:"Az-Zariyat",ayahs:60},{number:52,name:"At-Tur",ayahs:49},{number:53,name:"An-Najm",ayahs:62},{number:54,name:"Al-Qamar",ayahs:55},{number:55,name:"Ar-Rahman",ayahs:78},{number:56,name:"Al-Waqi'ah",ayahs:96},{number:57,name:"Al-Hadid",ayahs:29},{number:58,name:"Al-Mujadilah",ayahs:22},{number:59,name:"Al-Hasyr",ayahs:24},{number:60,name:"Al-Mumtahanah",ayahs:13},{number:61,name:"As-Saff",ayahs:14},{number:62,name:"Al-Jumu'ah",ayahs:11},{number:63,name:"Al-Munafiqun",ayahs:11},{number:64,name:"At-Taghabun",ayahs:18},{number:65,name:"At-Talaq",ayahs:12},{number:66,name:"At-Tahrim",ayahs:12},{number:67,name:"Al-Mulk",ayahs:30},{number:68,name:"Al-Qalam",ayahs:52},{number:69,name:"Al-Haqqah",ayahs:52},{number:70,name:"Al-Ma'arij",ayahs:44},{number:71,name:"Nuh",ayahs:28},{number:72,name:"Al-Jinn",ayahs:28},{number:73,name:"Al-Muzzammil",ayahs:20},{number:74,name:"Al-Muddassir",ayahs:56},{number:75,name:"Al-Qiyamah",ayahs:40},{number:76,name:"Al-Insan",ayahs:31},{number:77,name:"Al-Mursalat",ayahs:50},{number:78,name:"An-Naba'",ayahs:40},{number:79,name:"An-Nazi'at",ayahs:46},{number:80,name:"'Abasa",ayahs:42},{number:81,name:"At-Takwir",ayahs:29},{number:82,name:"Al-Infitar",ayahs:19},{number:83,name:"Al-Mutaffifin",ayahs:36},{number:84,name:"Al-Insyiqaq",ayahs:25},{number:85,name:"Al-Buruj",ayahs:22},{number:86,name:"At-Tariq",ayahs:17},{number:87,name:"Al-A'la",ayahs:19},{number:88,name:"Al-Ghasyiyah",ayahs:26},{number:89,name:"Al-Fajr",ayahs:30},{number:90,name:"Al-Balad",ayahs:20},{number:91,name:"Asy-Syams",ayahs:15},{number:92,name:"Al-Lail",ayahs:21},{number:93,name:"Ad-Duha",ayahs:11},{number:94,name:"Al-Insyirah",ayahs:8},{number:95,name:"At-Tin",ayahs:8},{number:96,name:"Al-'Alaq",ayahs:19},{number:97,name:"Al-Qadr",ayahs:5},{number:98,name:"Al-Bayyinah",ayahs:8},{number:99,name:"Az-Zalzalah",ayahs:8},{number:100,name:"Al-'Adiyat",ayahs:11},{number:101,name:"Al-Qari'ah",ayahs:11},{number:102,name:"At-Takasur",ayahs:8},{number:103,name:"Al-'Asr",ayahs:3},{number:104,name:"Al-Humazah",ayahs:9},{number:105,name:"Al-Fil",ayahs:5},{number:106,name:"Quraisy",ayahs:4},{number:107,name:"Al-Ma'un",ayahs:7},{number:108,name:"Al-Kausar",ayahs:3},{number:109,name:"Al-Kafirun",ayahs:6},{number:110,name:"An-Nasr",ayahs:3},{number:111,name:"Al-Lahab",ayahs:5},{number:112,name:"Al-Ikhlas",ayahs:4},{number:113,name:"Al-Falaq",ayahs:5},{number:114,name:"An-Nas",ayahs:6}];

        // ERROR BOUNDARY
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-red-50 flex items-center justify-center p-4 font-sans">
                            <div className="bg-white p-6 sm:p-8 rounded-3xl shadow-xl w-full max-w-md text-center border border-red-100">
                                <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><AlertTriangle className="w-8 h-8 text-red-600" /></div>
                                <h2 className="text-xl font-bold text-slate-800 mb-2">Sistem Sedang Memulihkan Diri</h2>
                                <p className="text-sm text-slate-600 mb-6">Ada sedikit sisa memori yang tertahan. Silakan klik tombol di bawah untuk membersihkan memori perangkat Anda secara otomatis.</p>
                                <button onClick={() => { localStorage.clear(); sessionStorage.clear(); window.location.reload(); }} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all">Bersihkan & Mulai Ulang</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- FIREBASE IMPORTS ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // =====================================================================
        // üõë MODE PUBLISH (CLOUD AKTIF) üõë
        // Silakan ubah tulisan "KOSONG" di bawah ini dengan kode Firebase Anda
        const FORCE_LOCAL_STORAGE = false; 
        
        const firebaseConfig = {
  apiKey: "AIzaSyBZ7_9eXqPiPRoroU8q4aIvxLWSgjG2SF8",
  authDomain: "jurnal-murojaahku.firebaseapp.com",
  projectId: "jurnal-murojaahku",
  storageBucket: "jurnal-murojaahku.firebasestorage.app",
  messagingSenderId: "471439272992",
  appId: "1:471439272992:web:8d6cc019f177d5385fa045"
};
        // =====================================================================

        let app, auth, db;
        let isCloudReady = false;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'jurnal-murojaah-tpq';

        try {
            if (!FORCE_LOCAL_STORAGE) {
                let activeConfig = null;
                const storedCustomConfig = localStorage.getItem('customFirebaseConfig');
                
                if (storedCustomConfig) {
                    try { activeConfig = JSON.parse(storedCustomConfig); } catch(e) {}
                } else if (firebaseConfig && firebaseConfig.apiKey !== "KOSONG") {
                    activeConfig = firebaseConfig;
                }

                if (activeConfig) {
                    app = initializeApp(activeConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    isCloudReady = true;
                }
            }
        } catch (error) {
            console.error("Gagal inisialisasi Firebase:", error);
        }

        function MainApp() {
          const [currentView, setCurrentView] = useState(() => sessionStorage.getItem('murojaah_currentView') || 'welcome');
          const [isLoading, setIsLoading] = useState(false);
          const [cloudStatus, setCloudStatus] = useState(isCloudReady ? 'connecting' : 'offline');
          const [firebaseUser, setFirebaseUser] = useState(null);
          
          // INIT STATES LOKAL YANG KOKOH
          const [data, setData] = useState(() => {
            try { 
                const saved = localStorage.getItem('murojaahData');
                if (saved) {
                    const parsed = JSON.parse(saved); 
                    if (Array.isArray(parsed) && parsed.length > 0 && parsed[0]?.id) {
                        return parsed;
                    }
                }
            } catch (e) {}
            return INITIAL_DATA; 
          });

          const [classes, setClasses] = useState(() => {
            try { 
                const saved = localStorage.getItem('murojaahClasses');
                if (saved) {
                    const parsed = JSON.parse(saved); 
                    if (Array.isArray(parsed) && parsed.length > 0) return parsed;
                }
            } catch (e) {}
            return DEFAULT_CLASS_LIST;
          });

          const [history, setHistory] = useState(() => {
            try { 
                const saved = localStorage.getItem('murojaahHistory');
                if (saved) {
                    const parsed = JSON.parse(saved); 
                    if (Array.isArray(parsed)) return parsed.filter(h => h && h.id && h.student);
                }
            } catch (e) {}
            return [];
          });

          const [scriptUrl, setScriptUrl] = useState(() => localStorage.getItem('murojaahScriptUrl') || '');

          const [selectedUstadz, setSelectedUstadz] = useState(() => {
              try { const s = sessionStorage.getItem('murojaah_selectedUstadz'); return s && s !== "undefined" ? JSON.parse(s) : null; } catch(e) { return null; }
          });
          const [selectedHalaqoh, setSelectedHalaqoh] = useState(() => {
              try { const s = sessionStorage.getItem('murojaah_selectedHalaqoh'); return s && s !== "undefined" ? JSON.parse(s) : null; } catch(e) { return null; }
          });
          
          const [selectedSurahs, setSelectedSurahs] = useState([]);
          const [selectedRanges, setSelectedRanges] = useState({});
          const [selectedStudent, setSelectedStudent] = useState("");
          const [selectedClass, setSelectedClass] = useState("");
          const [searchTerm, setSearchTerm] = useState("");
          const [showConfetti, setShowConfetti] = useState(false);
          
          const [historyFilter, setHistoryFilter] = useState("Semua");
          const [historyDateFilter, setHistoryDateFilter] = useState(""); 
          const [historyPage, setHistoryPage] = useState(1);
          const [adminSearchTerm, setAdminSearchTerm] = useState("");
          const [adminHistoryDateFilter, setAdminHistoryDateFilter] = useState("");
          const [adminHistoryPage, setAdminHistoryPage] = useState(1);

          const [isAdmin, setIsAdmin] = useState(() => sessionStorage.getItem('murojaah_isAdmin') === 'true');
          const [showLoginModal, setShowLoginModal] = useState(false);
          const [showSettingsModal, setShowSettingsModal] = useState(false);
          const [loginForm, setLoginForm] = useState({ username: '', password: '' });
          const [loginError, setLoginError] = useState(false);

          const [showUstadzModal, setShowUstadzModal] = useState(false);
          const [ustadzForm, setUstadzForm] = useState({ id: null, name: '', gender: 'male' });
          const [showHalaqohModal, setShowHalaqohModal] = useState(false);
          const [halaqohForm, setHalaqohForm] = useState({ id: null, name: '' });
          const [showManageStudentModal, setShowManageStudentModal] = useState(false);
          const [newStudentName, setNewStudentName] = useState("");
          const [editingStudentIndex, setEditingStudentIndex] = useState(null); 
          const [editStudentValue, setEditStudentValue] = useState(""); 
          const [showManageClassModal, setShowManageClassModal] = useState(false);
          const [classForm, setClassForm] = useState("");
          const [editingClassIdx, setEditingClassIdx] = useState(null);
          const [editClassText, setEditClassText] = useState("");

          const [showVerseModal, setShowVerseModal] = useState(false);
          const [activeSurahForPicker, setActiveSurahForPicker] = useState(null);
          const [verseInput, setVerseInput] = useState({ start: '', end: '' });
          const startVerseRef = useRef(null);

          const [deleteConfig, setDeleteConfig] = useState({ show: false, type: null, id: null, name: '', parentId: null });
          const [shareItem, setShareItem] = useState(null);
          const [isGeneratingImage, setIsGeneratingImage] = useState(null); 
          const shareCardRef = useRef(null);

          const [showEditHistoryModal, setShowEditHistoryModal] = useState(false);
          const [editingHistoryItem, setEditingHistoryItem] = useState(null);
          
          const [shareHalaqohItem, setShareHalaqohItem] = useState(null);
          const shareHalaqohCardRef = useRef(null);

          const [showBroadcastModal, setShowBroadcastModal] = useState(false);
          const [broadcastMessage, setBroadcastMessage] = useState("");
          const [activeBroadcast, setActiveBroadcast] = useState(null); 
          const [notifPermission, setNotifPermission] = useState(() => {
              return typeof Notification !== 'undefined' ? Notification.permission : 'default';
          });

          // SIMPAN OTOMATIS KE PENYIMPANAN LOKAL SETIAP ADA PERUBAHAN
          useEffect(() => { localStorage.setItem('murojaahData', JSON.stringify(Array.isArray(data) && data.length > 0 ? data : INITIAL_DATA)); }, [data]);
          useEffect(() => { localStorage.setItem('murojaahHistory', JSON.stringify(Array.isArray(history) ? history : [])); }, [history]);
          useEffect(() => { localStorage.setItem('murojaahClasses', JSON.stringify(Array.isArray(classes) && classes.length > 0 ? classes : DEFAULT_CLASS_LIST)); }, [classes]);
          useEffect(() => { localStorage.setItem('murojaahScriptUrl', scriptUrl); }, [scriptUrl]);
          useEffect(() => { sessionStorage.setItem('murojaah_currentView', currentView); }, [currentView]);
          useEffect(() => { sessionStorage.setItem('murojaah_selectedUstadz', JSON.stringify(selectedUstadz)); }, [selectedUstadz]);
          useEffect(() => { sessionStorage.setItem('murojaah_selectedHalaqoh', JSON.stringify(selectedHalaqoh)); }, [selectedHalaqoh]);
          useEffect(() => { sessionStorage.setItem('murojaah_isAdmin', isAdmin); }, [isAdmin]);

          useEffect(() => { if (selectedHalaqoh) { setSelectedStudent(""); setSelectedClass(""); } }, [selectedHalaqoh]);
          useEffect(() => { if (showVerseModal && startVerseRef.current) setTimeout(() => startVerseRef.current.focus(), 100); }, [showVerseModal]);

          const requestNotificationPermission = async () => {
             if (!("Notification" in window)) { alert("Perangkat Anda tidak mendukung Notifikasi Layar."); return; }
             const perm = await Notification.requestPermission();
             setNotifPermission(perm);
             if (perm === "granted") alert("Notifikasi diizinkan!");
          };

          const handleSendBroadcast = async () => {
             if (!broadcastMessage.trim()) return;
             if (!isCloudReady || !db) {
                 alert("Fitur ini membutuhkan koneksi Database Cloud yang aktif.");
                 return;
             }
             setIsLoading(true);
             try {
                 await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'murojaah_core', 'broadcast'), {
                     message: broadcastMessage.trim(),
                     timestamp: Date.now()
                 });
                 alert("Pengumuman berhasil dikirim ke semua pengguna!");
                 setShowBroadcastModal(false);
                 setBroadcastMessage("");
             } catch (e) { alert("Gagal mengirim pengumuman."); } 
             finally { setIsLoading(false); }
          };

          // --- FIREBASE SYNC LOGIC ---
          useEffect(() => {
              if (!isCloudReady || !auth) {
                  setCloudStatus('offline');
                  return;
              }
              const initAuth = async () => {
                  try {
                      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                          await signInWithCustomToken(auth, __initial_auth_token);
                      } else {
                          await signInAnonymously(auth);
                      }
                  } catch(e) { setCloudStatus('error'); }
              };
              initAuth();
              const unsubscribe = onAuthStateChanged(auth, (u) => {
                  setFirebaseUser(u);
                  if (u) setCloudStatus('online');
              });
              return () => unsubscribe();
          }, []);

          // Sync Data, History, dan Broadcast
          useEffect(() => {
              if (!firebaseUser || !db) return;
              const coreDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'murojaah_core', 'main');
              const broadcastDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'murojaah_core', 'broadcast');
              
              const fetchInitialCoreData = async () => {
                 try {
                     const docSnap = await getDoc(coreDocRef);
                     if (!docSnap.exists()) { await saveCoreToCloud(data, classes, scriptUrl); }
                 } catch (e) {}
              };
              fetchInitialCoreData();

              const unsubCore = onSnapshot(coreDocRef, (docSnap) => {
                  if (docSnap.exists()) {
                      const d = docSnap.data();
                      if (d.data) {
                          const incomingData = Array.isArray(d.data) ? d.data : [];
                          setData(incomingData.length > 0 ? incomingData : INITIAL_DATA);
                      }
                      if (d.classes) {
                          const incomingClasses = Array.isArray(d.classes) ? d.classes : [];
                          setClasses(incomingClasses.length > 0 ? incomingClasses : DEFAULT_CLASS_LIST);
                      }
                      if (d.scriptUrl !== undefined) setScriptUrl(d.scriptUrl);
                  }
              }, (error) => { setCloudStatus('error'); });

              const unsubHistory = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'murojaah_history'), (snapshot) => {
                  const hist = [];
                  snapshot.forEach(doc => { hist.push({ ...doc.data(), id: doc.id }); });
                  hist.sort((a, b) => new Date(b?.date || 0) - new Date(a?.date || 0));
                  setHistory(hist);
              });

              const unsubBroadcast = onSnapshot(broadcastDocRef, (docSnap) => {
                 if (docSnap.exists()) {
                     const bData = docSnap.data();
                     const lastSeen = localStorage.getItem('murojaah_last_broadcast');
                     if (bData.timestamp && bData.timestamp.toString() !== lastSeen) {
                         if (!isAdmin) {
                             let notifSuccess = false;
                             if ("Notification" in window && Notification.permission === 'granted') {
                                 try {
                                     new Notification("Pengumuman Jurnal Murojaah", { body: bData.message, icon: './logo.png' });
                                     notifSuccess = true;
                                     localStorage.setItem('murojaah_last_broadcast', bData.timestamp.toString());
                                 } catch (err) { notifSuccess = false; }
                             }
                             if (!notifSuccess) setActiveBroadcast(bData); 
                         } else {
                             localStorage.setItem('murojaah_last_broadcast', bData.timestamp.toString());
                         }
                     }
                 }
              });

              return () => { unsubCore(); unsubHistory(); unsubBroadcast(); };
          }, [firebaseUser, isAdmin]);

          const saveCoreToCloud = async (newData, newClasses, newScriptUrl = scriptUrl) => {
              if (!firebaseUser || !db) return;
              try {
                  await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'murojaah_core', 'main'), { 
                      data: newData || [], classes: newClasses || [], scriptUrl: newScriptUrl
                  });
              } catch(e) {}
          };

          const saveScriptUrl = (url) => {
              setScriptUrl(url);
              if (isCloudReady) saveCoreToCloud(data, classes, url);
          };

          const getSurahName = (num) => SURAH_LIST.find(s => s.number === num)?.name || `Surat ${num}`;
          const getFormattedDate = (iso) => new Date(iso).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
          const getDateOnly = (iso) => new Date(iso).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
          const getLocalDateString = (iso) => {
             if (!iso) return "";
             const d = new Date(iso);
             if (isNaN(d.getTime())) return "";
             return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
          };

          const handleShareClick = (item) => { setShareItem(item); };
          const triggerDownload = (url, filename) => {
              const link = document.createElement('a'); link.href = url; link.download = filename;
              document.body.appendChild(link); link.click(); document.body.removeChild(link);
          };

          const processImage = async (action) => {
              if (!shareCardRef.current) return;
              setIsGeneratingImage(action);
              try {
                  const canvas = await html2canvas(shareCardRef.current, { scale: 3, backgroundColor: null, useCORS: true, width: 320, height: 400 });
                  const imageBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                  const imageUrl = URL.createObjectURL(imageBlob);
                  const fileName = `Prestasi_Murojaah_${(shareItem?.student || 'Siswa').replace(/\s+/g, '_')}.png`;

                  if (action === 'share') {
                      if (navigator.canShare && navigator.canShare({ files: [new File([imageBlob], fileName, { type: 'image/png' })] })) {
                          const file = new File([imageBlob], fileName, { type: 'image/png' });
                          await navigator.share({ title: 'Prestasi Murojaah', text: `Alhamdulillah, ananda ${shareItem?.student} telah memurojaah hafalan.`, files: [file] });
                      } else {
                          alert("Perangkat Anda belum mendukung Share File secara langsung. Gambar diunduh.");
                          triggerDownload(imageUrl, fileName);
                      }
                  } else if (action === 'download') {
                      triggerDownload(imageUrl, fileName);
                      alert("Gambar berhasil diunduh!");
                  }
              } catch (error) { alert("Gagal memproses gambar."); } finally { setIsGeneratingImage(null); }
          };

          const handleShareHalaqohClick = (e, h) => {
              e.stopPropagation();
              setShareHalaqohItem({ ...h, ustadzName: selectedUstadz?.name });
          };

          const processHalaqohImage = async (action) => {
              if (!shareHalaqohCardRef.current) return;
              setIsGeneratingImage(action);
              try {
                  const canvas = await html2canvas(shareHalaqohCardRef.current, { scale: 3, backgroundColor: null, useCORS: true, width: 320, height: 400 });
                  const imageBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                  const imageUrl = URL.createObjectURL(imageBlob);
                  const fileName = `Daftar_Siswa_${(shareHalaqohItem?.name || 'Halaqoh').replace(/\s+/g, '_')}.png`;

                  if (action === 'share') {
                      if (navigator.canShare && navigator.canShare({ files: [new File([imageBlob], fileName, { type: 'image/png' })] })) {
                          const file = new File([imageBlob], fileName, { type: 'image/png' });
                          await navigator.share({ title: 'Daftar Siswa Halaqoh', text: `Daftar Siswa ${shareHalaqohItem?.name} bersama ${shareHalaqohItem?.ustadzName}.`, files: [file] });
                      } else {
                          alert("Perangkat Anda belum mendukung Share File secara langsung. Gambar diunduh.");
                          triggerDownload(imageUrl, fileName);
                      }
                  } else if (action === 'download') {
                      triggerDownload(imageUrl, fileName);
                      alert("Gambar berhasil diunduh!");
                  }
              } catch (error) { alert("Gagal memproses gambar."); } finally { setIsGeneratingImage(null); }
          };

          const topStudents = useMemo(() => {
              const stats = {};
              (Array.isArray(history) ? history : []).forEach(item => {
                  if (!item) return;
                  const key = `${item?.student}_${item?.class}`;
                  if (!stats[key]) { stats[key] = { student: item?.student, class: item?.class, surahCount: 0, sessionCount: 0 }; }
                  stats[key].sessionCount += 1;
                  stats[key].surahCount += Array.isArray(item?.surahs) ? item.surahs.length : 0;
              });
              return Object.values(stats).sort((a, b) => {
                  if (b.surahCount !== a.surahCount) return b.surahCount - a.surahCount;
                  return b.sessionCount - a.sessionCount;
              }).slice(0, 10);
          }, [history]);
          
          const halaqohLeaderboard = useMemo(() => {
              if (!selectedHalaqoh || !selectedUstadz) return [];
              const stats = {};
              (Array.isArray(selectedHalaqoh?.students) ? selectedHalaqoh.students : []).forEach(studentName => {
                  stats[studentName] = { student: studentName, class: '-', surahCount: 0, sessionCount: 0 };
              });
              const halaqohHistory = (Array.isArray(history) ? history : []).filter(item => 
                  item?.halaqohName === selectedHalaqoh?.name && item?.ustadzName === selectedUstadz?.name
              );
              halaqohHistory.forEach(item => {
                  const key = item?.student;
                  if (key) {
                      if (!stats[key]) stats[key] = { student: key, class: item?.class, surahCount: 0, sessionCount: 0 }; 
                      stats[key].sessionCount += 1;
                      stats[key].surahCount += Array.isArray(item?.surahs) ? item.surahs.length : 0;
                      if (item?.class) stats[key].class = item.class;
                  }
              });
              return Object.values(stats).sort((a, b) => {
                  if (b.surahCount !== a.surahCount) return b.surahCount - a.surahCount;
                  return b.sessionCount - a.sessionCount;
              });
          }, [history, selectedHalaqoh, selectedUstadz]);

          const { sortedUstadzData } = useMemo(() => {
              const counts = {};
              (Array.isArray(history) ? history : []).forEach(item => {
                  if (item?.ustadzName) counts[item.ustadzName] = (counts[item.ustadzName] || 0) + 1;
              });
              const safeData = Array.isArray(data) ? data : [];
              const sorted = [...safeData].sort((a, b) => {
                  const countA = counts[a?.name] || 0;
                  const countB = counts[b?.name] || 0;
                  if (countB !== countA) return countB - countA;
                  return safeData.indexOf(a) - safeData.indexOf(b);
              });
              return { sortedUstadzData: sorted };
          }, [data, history]);

          const refreshSelectedData = (newData) => {
            const safeNewData = Array.isArray(newData) && newData.length > 0 ? newData : INITIAL_DATA;
            setData(safeNewData);
            if (selectedUstadz) {
               const newUstadz = safeNewData.find(u => u?.id === selectedUstadz?.id);
               setSelectedUstadz(newUstadz || null);
               if (selectedHalaqoh && newUstadz) {
                  const newHalaqoh = (Array.isArray(newUstadz.halaqohs) ? newUstadz.halaqohs : []).find(h => h?.id === selectedHalaqoh?.id);
                  setSelectedHalaqoh(newHalaqoh || null);
               }
            }
          };

          // NAVIGATION FUNCTIONS
          const handleSelectUstadz = (u) => { setSelectedUstadz(u); setCurrentView('select-halaqoh'); };
          const handleSelectHalaqoh = (h) => { setSelectedHalaqoh(h); setCurrentView('home'); };
          const handleBack = () => {
            if (currentView === 'history' || currentView === 'leaderboard' || currentView === 'home') setCurrentView('select-halaqoh');
            else if (currentView === 'select-halaqoh') setCurrentView('select-ustadz');
            else if (currentView === 'select-ustadz') setCurrentView('welcome');
            else if (currentView === 'admin-dashboard') setCurrentView('select-ustadz');
          };

          const handleLogin = (e) => {
            e.preventDefault();
            if (loginForm.username === 'jumanjayyidin' && loginForm.password === 'offthewallba123') {
              setIsAdmin(true); setShowLoginModal(false); setLoginForm({ username: '', password: '' }); setLoginError(false);
            } else { setLoginError(true); setLoginForm(prev => ({...prev, password: ''})); }
          };

          const handleLogout = () => { setIsAdmin(false); setShowManageStudentModal(false); setShowSettingsModal(false); setCurrentView('welcome'); };

          const openAddUstadz = () => { setUstadzForm({ id: null, name: '', gender: 'male' }); setShowUstadzModal(true); };
          const openEditUstadz = (e, u) => { e.stopPropagation(); setUstadzForm(u); setShowUstadzModal(true); };
          const handleDeleteUstadzReq = (e, u) => { e.stopPropagation(); setDeleteConfig({ show: true, type: 'ustadz', id: u?.id, name: u?.name }); };
          
          const saveUstadz = (e) => {
             e.preventDefault();
             if (!ustadzForm.name.trim()) return;
             const safeData = Array.isArray(data) ? data : [];
             let newData;
             if (ustadzForm.id) newData = safeData.map(u => u?.id === ustadzForm.id ? { ...u, name: ustadzForm.name, gender: ustadzForm.gender } : u);
             else newData = [...safeData, { id: `ust-${Date.now()}`, name: ustadzForm.name, gender: ustadzForm.gender, halaqohs: [] }];
             refreshSelectedData(newData);
             if (isCloudReady) saveCoreToCloud(newData, classes);
             setShowUstadzModal(false);
          };

          const openAddHalaqoh = () => { setHalaqohForm({ id: null, name: '' }); setShowHalaqohModal(true); };
          const openEditHalaqoh = (e, h) => { e.stopPropagation(); setHalaqohForm(h); setShowHalaqohModal(true); };
          const handleDeleteHalaqohReq = (e, h) => { e.stopPropagation(); setDeleteConfig({ show: true, type: 'halaqoh', id: h?.id, name: h?.name, parentId: selectedUstadz?.id }); };
          
          const saveHalaqoh = (e) => {
             e.preventDefault();
             if (!halaqohForm.name.trim()) return;
             const safeData = Array.isArray(data) ? data : [];
             const newData = safeData.map(u => {
                if (u?.id === selectedUstadz?.id) {
                   const safeHalaqohs = Array.isArray(u.halaqohs) ? u.halaqohs : [];
                   if (halaqohForm.id) return { ...u, halaqohs: safeHalaqohs.map(h => h?.id === halaqohForm.id ? { ...h, name: halaqohForm.name } : h) }; 
                   else return { ...u, halaqohs: [...safeHalaqohs, { id: `h-${Date.now()}`, name: halaqohForm.name, students: [] }] }; 
                }
                return u;
             });
             refreshSelectedData(newData);
             if (isCloudReady) saveCoreToCloud(newData, classes);
             setShowHalaqohModal(false);
          };

          const handleAddStudent = (e) => {
            e.preventDefault();
            if (!newStudentName.trim() || !selectedHalaqoh || !selectedUstadz) return;
            const safeData = Array.isArray(data) ? data : [];
            const newData = safeData.map(u => {
              if (u?.id === selectedUstadz?.id) {
                const safeHalaqohs = Array.isArray(u.halaqohs) ? u.halaqohs : [];
                return { ...u, halaqohs: safeHalaqohs.map(h => {
                    if (h?.id === selectedHalaqoh?.id) { 
                        const safeStudents = Array.isArray(h.students) ? h.students : [];
                        return { ...h, students: [...safeStudents, newStudentName.trim()] }; 
                    }
                    return h;
                  })
                };
              }
              return u;
            });
            refreshSelectedData(newData);
            if (isCloudReady) saveCoreToCloud(newData, classes);
            setNewStudentName("");
          };

          const handleMoveUstadz = (index, direction) => {
            const safeData = Array.isArray(data) ? [...data] : [];
            if (direction === 'up' && index > 0) [safeData[index], safeData[index - 1]] = [safeData[index - 1], safeData[index]];
            else if (direction === 'down' && index < safeData.length - 1) [safeData[index], safeData[index + 1]] = [safeData[index + 1], safeData[index]];
            else return;
            refreshSelectedData(safeData);
            if (isCloudReady) saveCoreToCloud(safeData, classes);
          };

          const handleMoveStudent = (index, direction) => {
            if (!selectedHalaqoh) return;
            const newStudents = Array.isArray(selectedHalaqoh.students) ? [...selectedHalaqoh.students] : [];
            if (direction === 'up' && index > 0) [newStudents[index], newStudents[index - 1]] = [newStudents[index - 1], newStudents[index]];
            else if (direction === 'down' && index < newStudents.length - 1) [newStudents[index], newStudents[index + 1]] = [newStudents[index + 1], newStudents[index]];
            else return;
            const safeData = Array.isArray(data) ? data : [];
            const updatedData = safeData.map(u => {
                if (u?.id === selectedUstadz?.id) {
                    const safeHalaqohs = Array.isArray(u.halaqohs) ? u.halaqohs : [];
                    return { ...u, halaqohs: safeHalaqohs.map(h => {
                            if (h?.id === selectedHalaqoh?.id) return { ...h, students: newStudents };
                            return h;
                        })
                    };
                }
                return u;
            });
            refreshSelectedData(updatedData);
            if (isCloudReady) saveCoreToCloud(updatedData, classes);
          };

          const startEditingStudent = (index) => { setEditingStudentIndex(index); setEditStudentValue(selectedHalaqoh?.students?.[index] || ""); };
          const saveEditStudent = (index) => {
            const trimmedValue = editStudentValue.trim();
            if (!trimmedValue) return;
            const newStudents = Array.isArray(selectedHalaqoh.students) ? [...selectedHalaqoh.students] : [];
            newStudents[index] = trimmedValue;
            const safeData = Array.isArray(data) ? data : [];
            const updatedData = safeData.map(u => {
                if (u?.id === selectedUstadz?.id) {
                    const safeHalaqohs = Array.isArray(u.halaqohs) ? u.halaqohs : [];
                    return { ...u, halaqohs: safeHalaqohs.map(h => {
                            if (h?.id === selectedHalaqoh?.id) return { ...h, students: newStudents };
                            return h;
                        })
                    };
                }
                return u;
            });
            if (selectedStudent === selectedHalaqoh?.students?.[index]) setSelectedStudent(trimmedValue);
            refreshSelectedData(updatedData);
            if (isCloudReady) saveCoreToCloud(updatedData, classes);
            setEditingStudentIndex(null);
            setEditStudentValue("");
          };

          const startEditingClass = (index) => { setEditingClassIdx(index); setEditClassText(classes?.[index] || ""); };
          const handleAddClass = (e) => {
            e.preventDefault();
            if (!classForm.trim()) return;
            const safeClasses = Array.isArray(classes) ? classes : [];
            if (safeClasses.includes(classForm.trim())) { alert("Kelas sudah ada!"); return; }
            const newClasses = [...safeClasses, classForm.trim()];
            setClasses(newClasses);
            if (isCloudReady) saveCoreToCloud(data, newClasses);
            setClassForm("");
          };
          
          const saveClassEdit = (index) => {
            const newVal = editClassText.trim();
            if (!newVal) return;
            const safeClasses = Array.isArray(classes) ? classes : [];
            if (newVal !== safeClasses[index] && safeClasses.includes(newVal)) { alert("Nama kelas sudah digunakan!"); return; }
            const newClasses = [...safeClasses];
            const oldName = newClasses[index];
            newClasses[index] = newVal;
            setClasses(newClasses);
            if (selectedClass === oldName) setSelectedClass(newVal);
            const safeHistory = Array.isArray(history) ? history : [];
            const updatedHistory = safeHistory.map(h => h?.class === oldName ? { ...h, class: newVal } : h);
            setHistory(updatedHistory);
            if (isCloudReady) saveCoreToCloud(data, newClasses);
            setEditingClassIdx(null);
            setEditClassText("");
          };
          const cancelEditClass = () => { setEditingClassIdx(null); setEditClassText(""); };

          const executeDelete = async () => {
             const safeData = Array.isArray(data) ? data : [];
             let newData = [...safeData];
             if (deleteConfig.type === 'history') {
                if (isCloudReady && firebaseUser && db && deleteConfig.id) {
                    try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'murojaah_history', deleteConfig.id.toString())); } 
                    catch(e) { console.error("Hapus cloud gagal", e); }
                } else { 
                    setHistory(h => (Array.isArray(h) ? h : []).filter(i => i?.id !== deleteConfig.id)); 
                }
                setDeleteConfig({ ...deleteConfig, show: false });
                return;
             } 
             if (deleteConfig.type === 'class') {
                const className = deleteConfig.name;
                const newClasses = (Array.isArray(classes) ? classes : []).filter(c => c !== className);
                setClasses(newClasses);
                if (selectedClass === className) setSelectedClass(newClasses[0] || "");
                if (isCloudReady) saveCoreToCloud(data, newClasses);
                setDeleteConfig({ ...deleteConfig, show: false });
                return;
             }
             if (deleteConfig.type === 'ustadz') {
                newData = newData.filter(u => u?.id !== deleteConfig.id);
                if (selectedUstadz?.id === deleteConfig.id) setSelectedUstadz(null);
             } else if (deleteConfig.type === 'halaqoh') {
                newData = newData.map(u => {
                   if (u?.id === deleteConfig.parentId) { 
                       const safeHalaqohs = Array.isArray(u.halaqohs) ? u.halaqohs : [];
                       return { ...u, halaqohs: safeHalaqohs.filter(h => h?.id !== deleteConfig.id) }; 
                   }
                   return u;
                });
                if (selectedHalaqoh?.id === deleteConfig.id) setSelectedHalaqoh(null);
             } else if (deleteConfig.type === 'student') {
                newData = newData.map(u => {
                   if (u?.id === selectedUstadz?.id) {
                      const safeHalaqohs = Array.isArray(u.halaqohs) ? u.halaqohs : [];
                      return { ...u, halaqohs: safeHalaqohs.map(h => {
                            if (h?.id === selectedHalaqoh?.id) { 
                                const safeStudents = Array.isArray(h.students) ? h.students : [];
                                return { ...h, students: safeStudents.filter(s => s !== deleteConfig.name) }; 
                            }
                            return h;
                         })
                      };
                   }
                   return u;
                });
             }
             refreshSelectedData(newData);
             if (isCloudReady) saveCoreToCloud(newData, classes);
             setDeleteConfig({ ...deleteConfig, show: false });
          };

          const handleSaveHistoryEdit = async (e) => {
              e.preventDefault();
              if (!editingHistoryItem || !editingHistoryItem.id) return;
              setIsLoading(true);
              try {
                  if (isCloudReady && firebaseUser && db) {
                      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'murojaah_history', editingHistoryItem.id.toString()), editingHistoryItem, { merge: true });
                  } else {
                      setHistory(prev => (Array.isArray(prev) ? prev : []).map(h => h?.id === editingHistoryItem.id ? editingHistoryItem : h));
                  }
                  setShowEditHistoryModal(false);
                  setEditingHistoryItem(null);
              } catch(err) { alert("Gagal menyimpan perubahan riwayat."); } 
              finally { setIsLoading(false); }
          };

          const toggleSurah = (surah) => {
            const safeSurahs = Array.isArray(selectedSurahs) ? selectedSurahs : [];
            if (safeSurahs.includes(surah.number)) {
              setSelectedSurahs(prev => (Array.isArray(prev) ? prev : []).filter(id => id !== surah.number));
              setSelectedRanges(prev => { const next = { ...(prev || {}) }; delete next[surah.number]; return next; });
            } else {
              setActiveSurahForPicker(surah);
              setVerseInput({ start: '', end: '' });
              setShowVerseModal(true);
            }
          };

          const handleVerseInputChange = (field, value) => { if (value === '' || (parseInt(value) > 0)) { setVerseInput(prev => ({ ...prev, [field]: value })); } };

          const saveVerseSelection = (isFullSurah = false) => {
            if (!activeSurahForPicker) return;
            const surahId = activeSurahForPicker.number;
            let rangeString = null;
            if (!isFullSurah) {
                const { start, end } = verseInput;
                if (start && end) rangeString = start === end ? `Ayat ${start}` : `Ayat ${start}-${end}`;
                else if (start) rangeString = `Ayat ${start}`;
            }
            setSelectedSurahs(prev => [...(Array.isArray(prev) ? prev : []), surahId]);
            if (rangeString) setSelectedRanges(prev => ({ ...(prev || {}), [surahId]: rangeString }));
            setShowVerseModal(false);
            setActiveSurahForPicker(null);
          };

          const handleSaveSession = async () => {
            if (isLoading) return; 
            if (!selectedStudent) { alert("Silakan pilih Siswa terlebih dahulu!"); return; }
            if (!selectedClass) { alert("Silakan pilih Kelas terlebih dahulu!"); return; }
            if (!Array.isArray(selectedSurahs) || selectedSurahs.length === 0) { alert("Pilih minimal 1 surat untuk disetorkan!"); return; }

            const lastSubmitKey = `lastSubmit_${selectedStudent}`;
            const lastSubmitTime = localStorage.getItem(lastSubmitKey);
            if (lastSubmitTime && (Date.now() - parseInt(lastSubmitTime) < 3600000)) { 
                alert(`Data murojaah untuk ananda ${selectedStudent} telah diinput.`);
                return;
            }

            setIsLoading(true); 
            
            let userIp = "Unknown IP";
            try {
                const ipRes = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipRes.json();
                userIp = ipData.ip;
            } catch (e) { console.log("Gagal mendapatkan IP"); }
            
            const userDevice = navigator.userAgent;

            const surahDetails = [...selectedSurahs].sort((a, b) => a - b).map(num => {
                const name = getSurahName(num);
                const range = (selectedRanges || {})[num];
                return range ? `${name} (${range})` : name;
            }).join(", ");
            
            const uniqueId = Date.now().toString();
            const newEntry = {
              id: uniqueId,
              date: new Date().toISOString(),
              student: selectedStudent,
              class: selectedClass,
              ustadzName: selectedUstadz?.name || '',
              halaqohName: selectedHalaqoh?.name || '',
              surahs: [...selectedSurahs].sort((a, b) => a - b),
              ranges: { ...(selectedRanges || {}) },
              ipAddress: userIp,
              userAgent: userDevice
            };
            
            if (isCloudReady && firebaseUser && db) {
                try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'murojaah_history', uniqueId), newEntry); } 
                catch(e) { console.error("Gagal simpan riwayat ke cloud", e); }
            } else {
                setHistory(prev => [newEntry, ...(Array.isArray(prev) ? prev : [])]);
            }

            if (scriptUrl) {
              try {
                await fetch(scriptUrl, {
                  method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    date: new Date().toLocaleString('id-ID'), student: selectedStudent, class: selectedClass,
                    ustadz: selectedUstadz?.name || '', halaqoh: selectedHalaqoh?.name || '', surahs: surahDetails
                  }),
                });
              } catch (e) { console.log("Info: Gagal terhubung ke Google Sheets"); } 
            }

            localStorage.setItem(lastSubmitKey, Date.now().toString());
            setSelectedSurahs([]); setSelectedRanges({}); setSelectedStudent(""); setSelectedClass("");
            setIsLoading(false); 
            
            setShowConfetti(true);
            setTimeout(() => { setShowConfetti(false); setCurrentView('history'); }, 1500);
          };

          const filteredSurahs = SURAH_LIST.filter(s => s.name.toLowerCase().includes((searchTerm || '').toLowerCase()) || s.number.toString().includes(searchTerm || ''));

          const HeaderUI = (title, subtitle) => (
            <div className="sticky top-0 z-50 bg-orange-600 text-white p-4 sm:p-6 shadow-lg rounded-b-3xl">
              <div className="flex justify-between items-center max-w-xl mx-auto">
                <div className="flex items-center gap-3 overflow-hidden">
                   <button onClick={handleBack} className="p-1.5 sm:p-2 bg-orange-500/50 hover:bg-orange-500 rounded-full transition-colors flex-shrink-0"><ArrowLeft className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                   <div className="overflow-hidden">
                     <h1 className="text-base sm:text-lg md:text-xl font-bold truncate">{title || ''}</h1>
                     {subtitle && <p className="text-orange-100 text-[9px] sm:text-[10px] md:text-xs truncate">{subtitle}</p>}
                   </div>
                </div>
                <div className="flex gap-2">
                   {isAdmin && (
                       <div className="flex items-center gap-1 sm:gap-2">
                           <div className={`hidden sm:flex items-center gap-1 px-2 py-1 rounded-lg text-[10px] font-bold border border-white/20 ${cloudStatus === 'online' ? 'bg-green-500/20 text-green-100' : 'bg-red-500/20 text-red-100'}`} title={cloudStatus === 'online' ? "Database Cloud Aktif" : "Database Offline (Lokal)"}>
                               {cloudStatus === 'online' ? <Cloud className="w-3 h-3"/> : <CloudOff className="w-3 h-3"/>}
                           </div>
                           <button onClick={() => setShowBroadcastModal(true)} className="p-1.5 sm:p-2 rounded-xl bg-orange-500/30 text-orange-100 hover:bg-orange-500/50 flex-shrink-0" title="Kirim Pengumuman"><Megaphone className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                           <button onClick={() => setShowSettingsModal(true)} className="p-1.5 sm:p-2 rounded-xl bg-orange-500/30 text-orange-100 hover:bg-orange-500/50 flex-shrink-0"><Settings className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                           <button onClick={() => setCurrentView('admin-dashboard')} className="p-1.5 sm:p-2 rounded-xl bg-orange-500/30 text-orange-100 hover:bg-orange-500/50 flex-shrink-0" title="Dashboard Admin"><LayoutDashboard className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                       </div>
                   )}
                  <button onClick={isAdmin ? handleLogout : () => setShowLoginModal(true)} className={`p-1.5 sm:p-2 rounded-xl transition-all flex-shrink-0 ${isAdmin ? 'bg-red-500/20 text-red-100' : 'bg-orange-500/30 text-orange-100'}`}>
                    {isAdmin ? <LogOut className="w-4 h-4 sm:w-5 sm:h-5" /> : <Lock className="w-4 h-4 sm:w-5 sm:h-5" />}
                  </button>
                </div>
              </div>
            </div>
          );

          return (
            <div className="min-h-screen bg-orange-50 text-slate-800 font-sans pb-24 relative">
              
              {/* --- TAMPILAN BANNER PENGUMUMAN (BROADCAST) UNTUK PENGUNJUNG --- */}
              {activeBroadcast && (
                  <div className="fixed inset-0 z-[300] flex items-center justify-center bg-black/70 backdrop-blur-md p-4 animate-in fade-in">
                     <div className="bg-gradient-to-br from-blue-600 to-blue-800 text-white p-6 sm:p-8 rounded-[2rem] shadow-2xl w-full max-w-sm relative text-center transform transition-all animate-in zoom-in-95">
                        <div className="w-14 h-14 sm:w-16 sm:h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
                           <Megaphone className="w-6 h-6 sm:w-8 sm:h-8 text-white animate-pulse" />
                        </div>
                        <h3 className="text-xl sm:text-2xl font-bold mb-3">Pengumuman</h3>
                        <div className="bg-black/20 p-4 rounded-xl mb-6 border border-white/10 text-left">
                           <p className="text-blue-50 text-sm sm:text-base leading-relaxed whitespace-pre-wrap">
                              {activeBroadcast.message}
                           </p>
                        </div>
                        <button 
                            onClick={() => {
                               localStorage.setItem('murojaah_last_broadcast', activeBroadcast.timestamp.toString());
                               setActiveBroadcast(null);
                            }} 
                            className="w-full bg-white text-blue-700 font-bold py-3 sm:py-3.5 rounded-xl shadow-lg hover:bg-blue-50 active:scale-95 transition-all text-sm sm:text-base"
                        >
                            Tutup & Paham
                        </button>
                     </div>
                  </div>
              )}

              {/* WELCOME VIEW DI DALAM SINI */}
              {currentView === 'welcome' && (
                  <div className="min-h-screen flex items-center justify-center p-4 text-white relative overflow-x-hidden font-sans py-12">
                     <div className="fixed top-0 left-0 w-full h-full z-0 bg-cover bg-center bg-no-repeat" style={{ backgroundImage: "url('https://images.unsplash.com/photo-1609599006353-e629aaabfeae?q=80&w=1920&auto=format&fit=crop')" }}></div>
                     <div className="fixed top-0 left-0 w-full h-full z-0 bg-black/75 backdrop-blur-[2px]"></div>
                     
                     {/* Tombol Izin Notifikasi (Posisi Absolute di pojok atas luar frame utama) */}
                     {notifPermission !== 'granted' && "Notification" in window && (
                         <button 
                             onClick={requestNotificationPermission} 
                             className="absolute top-4 right-4 z-50 flex items-center gap-1.5 bg-black/40 hover:bg-black/60 backdrop-blur-md text-white text-[10px] sm:text-xs px-3 py-1.5 rounded-full border border-white/20 transition-all shadow-lg"
                         >
                             <BellRing className="w-3 h-3 sm:w-3.5 sm:h-3.5 text-orange-400" /> 
                             Izinkan Notif
                         </button>
                     )}

                     <div className="relative z-10 w-full max-w-md animate-in fade-in zoom-in duration-700 mt-4 mb-8">
                        <div className="bg-white/10 backdrop-blur-md border border-white/20 p-6 sm:p-8 rounded-[2.5rem] shadow-2xl flex flex-col items-center text-center">
                           
                           <div className="bg-white p-2 sm:p-3 rounded-2xl shadow-lg mb-5 w-full max-w-[280px]">
                              <img 
                                src="./logo.png" 
                                onError={(e) => { e.target.style.display = 'none'; }}
                                alt="Logo SDIT Al-Fityan" 
                                className="h-10 sm:h-14 w-full object-contain" 
                              />
                           </div>

                           <div className="mb-1">
                              <h1 className="text-2xl sm:text-3xl md:text-4xl font-bold text-white tracking-tight">Jurnal Murojaahku</h1>
                           </div>
                           <p className="text-sm sm:text-base text-orange-200 font-medium mb-6 tracking-wide">SDIT Al Fityan School Bogor</p>

                           {/* SECTION HADITS */}
                           <div className="bg-black/20 p-4 sm:p-5 rounded-2xl w-full mb-6 border border-white/5 relative">
                              <div className="absolute -top-3 left-1/2 -translate-x-1/2 bg-orange-500 text-white text-[9px] sm:text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wider">
                                 Hadits
                              </div>
                              <p className="text-xs sm:text-sm md:text-base font-serif italic mb-2 text-orange-50 leading-relaxed mt-2">
                                 "Sebaik-baik kalian adalah yang belajar Al-Qur'an dan mengajarkannya."
                              </p>
                              <p className="text-[9px] sm:text-[10px] text-orange-300 font-bold tracking-widest uppercase">
                                 (HR. Bukhari no. 5027)
                              </p>
                           </div>

                           <button 
                              onClick={() => setCurrentView('select-ustadz')} 
                              className="group w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-400 hover:to-orange-500 text-white py-3 sm:py-4 rounded-xl font-bold text-base sm:text-lg shadow-xl flex items-center justify-center gap-3 transition-all transform hover:scale-[1.02] active:scale-95 mb-4"
                           >
                              Mulai Murojaah <ArrowRight className="w-5 h-5 group-hover:translate-x-1 transition-transform" />
                           </button>

                           {/* SECTION PRESTASI */}
                           {(topStudents || []).length > 0 && (
                              <div className="w-full bg-black/30 rounded-2xl p-4 sm:p-5 border border-white/10 relative mt-2">
                                 <div className="absolute -top-4 left-1/2 -translate-x-1/2 bg-gradient-to-r from-yellow-500 to-amber-500 text-yellow-950 px-3 sm:px-4 py-1.5 rounded-full font-bold text-[10px] sm:text-xs uppercase tracking-wider flex items-center gap-1 shadow-lg border border-yellow-300/50 whitespace-nowrap">
                                    <Medal className="w-3 h-3 sm:w-4 sm:h-4" /> Bintang Murojaah
                                 </div>
                                 <div className="space-y-2 mt-4 max-h-64 overflow-y-auto custom-scrollbar pr-1">
                                    {topStudents.map((user, idx) => (
                                       <div key={idx} className="flex items-center justify-between bg-white/5 hover:bg-white/10 transition-colors p-2.5 sm:p-3 rounded-xl border border-white/5 gap-2">
                                          <div className="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                                             <div className={`w-6 h-6 sm:w-7 sm:h-7 flex items-center justify-center rounded-full text-[10px] sm:text-xs font-bold shadow-sm flex-shrink-0 ${idx === 0 ? 'bg-yellow-400 text-yellow-900 ring-2 ring-yellow-400/50' : idx === 1 ? 'bg-slate-300 text-slate-800' : idx === 2 ? 'bg-amber-600 text-amber-50' : 'bg-white/10 text-white'}`}>{idx + 1}</div>
                                             <div className="text-left flex-1 min-w-0">
                                                <div className="text-[11px] sm:text-xs md:text-sm font-bold text-white line-clamp-2 leading-tight">{user?.student || 'Siswa'}</div>
                                                <div className="text-[9px] sm:text-[10px] text-orange-200 truncate mt-0.5">{user?.class || '-'}</div>
                                             </div>
                                          </div>
                                          <div className="text-right flex flex-col justify-center flex-shrink-0 pl-2">
                                             <div className="text-[11px] sm:text-xs font-bold text-yellow-400">{user?.surahCount || 0} Surat</div>
                                             <div className="text-[8px] sm:text-[9px] text-white/60">{user?.sessionCount || 0} Setoran</div>
                                          </div>
                                       </div>
                                    ))}
                                 </div>
                              </div>
                           )}
                        </div>
                     </div>
                     <div className="fixed bottom-4 left-0 right-0 text-center text-white/40 text-[10px] sm:text-xs font-medium z-20">&copy; 2026 Juman Jayyidin. All rights reserved.</div>
                  </div>
              )}

              {/* MODALS KELOLA & LAINNYA DIKEMBALIKAN */}
              {deleteConfig.show && (
                <div className="fixed inset-0 z-[170] flex items-center justify-center bg-black/60 p-4 animate-in fade-in">
                   <div className="bg-white p-5 sm:p-6 rounded-3xl w-full max-w-sm text-center">
                      <div className="w-12 h-12 sm:w-16 sm:h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce"><Trash2 className="w-6 h-6 sm:w-8 sm:h-8 text-red-600" /></div>
                      <h3 className="text-lg sm:text-xl font-bold mb-2">Hapus {deleteConfig.type === 'class' ? 'Kelas' : 'Item'}?</h3>
                      <div className="flex gap-2 sm:gap-3 mt-6">
                         <button onClick={() => setDeleteConfig({ ...deleteConfig, show: false })} className="flex-1 py-2.5 sm:py-3 bg-slate-100 rounded-xl font-bold text-sm sm:text-base">Batal</button>
                         <button onClick={executeDelete} className="flex-1 py-2.5 sm:py-3 bg-red-500 text-white rounded-xl font-bold text-sm sm:text-base">Hapus</button>
                      </div>
                   </div>
                </div>
              )}

              {showLoginModal && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                  <div className="bg-white p-6 sm:p-8 rounded-3xl shadow-2xl w-full max-w-sm relative">
                    <button onClick={() => { setShowLoginModal(false); setLoginError(false); }} className="absolute top-4 right-4 text-slate-400"><X className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                    <div className="text-center mb-6">
                      <div className="w-14 h-14 sm:w-16 sm:h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4"><Lock className="w-6 h-6 sm:w-8 sm:h-8 text-orange-600" /></div>
                      <h2 className="text-lg sm:text-xl font-bold">Login Admin</h2>
                    </div>
                    {loginError && (<div className="bg-red-50 text-red-600 border border-red-200 p-3 rounded-xl mb-4 text-xs sm:text-sm font-semibold flex items-center justify-center gap-2 animate-in fade-in zoom-in"><AlertTriangle className="w-4 h-4 sm:w-5 sm:h-5" /> User atau Password salah!</div>)}
                    <form onSubmit={handleLogin} className="space-y-3 sm:space-y-4">
                      <input type="text" value={loginForm.username} onChange={e=>{setLoginForm({...loginForm, username:e.target.value}); setLoginError(false);}} className="w-full px-3 py-2.5 sm:px-4 sm:py-3 rounded-xl border border-slate-200 outline-none text-sm sm:text-base focus:border-orange-500 transition-colors" placeholder="Username" />
                      <input type="password" value={loginForm.password} onChange={e=>{setLoginForm({...loginForm, password:e.target.value}); setLoginError(false);}} className="w-full px-3 py-2.5 sm:px-4 sm:py-3 rounded-xl border border-slate-200 outline-none text-sm sm:text-base focus:border-orange-500 transition-colors" placeholder="Password" />
                      <button className="w-full bg-orange-600 text-white font-bold py-2.5 sm:py-3 rounded-xl shadow-lg text-sm sm:text-base hover:bg-orange-700 active:scale-95 transition-all">Masuk</button>
                    </form>
                  </div>
                </div>
              )}

              {showUstadzModal && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                   <div className="bg-white p-5 sm:p-6 rounded-3xl w-full max-w-sm">
                      <h2 className="text-base sm:text-lg font-bold mb-4">{ustadzForm.id ? "Edit Pengajar" : "Tambah Pengajar"}</h2>
                      <form onSubmit={saveUstadz} className="space-y-3 sm:space-y-4">
                         <input type="text" value={ustadzForm.name} onChange={e => setUstadzForm({...ustadzForm, name: e.target.value})} className="w-full px-3 py-2 sm:px-4 sm:py-2.5 rounded-xl border border-slate-200 text-sm sm:text-base focus:border-orange-500 outline-none" placeholder="Nama Ustadz" autoFocus />
                         <div className="flex gap-2">
                            <button type="button" onClick={() => setUstadzForm({...ustadzForm, gender: 'male'})} className={`flex-1 py-2 sm:py-2.5 rounded-xl border text-sm sm:text-base ${ustadzForm.gender === 'male' ? 'bg-blue-100 text-blue-700' : ''}`}>Laki-laki</button>
                            <button type="button" onClick={() => setUstadzForm({...ustadzForm, gender: 'female'})} className={`flex-1 py-2 sm:py-2.5 rounded-xl border text-sm sm:text-base ${ustadzForm.gender === 'female' ? 'bg-pink-100 text-pink-700' : ''}`}>Perempuan</button>
                         </div>
                         <div className="flex gap-2 pt-2">
                            <button type="button" onClick={() => setShowUstadzModal(false)} className="flex-1 py-2.5 sm:py-3 bg-slate-100 rounded-xl text-sm sm:text-base">Batal</button>
                            <button type="submit" className="flex-1 py-2.5 sm:py-3 bg-orange-600 text-white font-bold rounded-xl text-sm sm:text-base">Simpan</button>
                         </div>
                      </form>
                   </div>
                </div>
              )}

              {showHalaqohModal && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                   <div className="bg-white p-5 sm:p-6 rounded-3xl w-full max-w-sm">
                      <h2 className="text-base sm:text-lg font-bold mb-4">{halaqohForm.id ? "Edit Halaqoh" : "Tambah Halaqoh"}</h2>
                      <form onSubmit={saveHalaqoh} className="space-y-3 sm:space-y-4">
                         <input type="text" value={halaqohForm.name} onChange={e => setHalaqohForm({...halaqohForm, name: e.target.value})} className="w-full px-3 py-2 sm:px-4 sm:py-2.5 rounded-xl border border-slate-200 text-sm sm:text-base focus:border-orange-500 outline-none" placeholder="Nama Halaqoh" autoFocus />
                         <div className="flex gap-2 pt-2">
                            <button type="button" onClick={() => setShowHalaqohModal(false)} className="flex-1 py-2.5 sm:py-3 bg-slate-100 rounded-xl text-sm sm:text-base">Batal</button>
                            <button type="submit" className="flex-1 py-2.5 sm:py-3 bg-orange-600 text-white font-bold rounded-xl text-sm sm:text-base">Simpan</button>
                         </div>
                      </form>
                   </div>
                </div>
              )}

              {showSettingsModal && (
                <div className="fixed inset-0 z-[110] flex items-center justify-center bg-black/50 p-4 animate-in fade-in">
                  <div className="bg-white p-5 sm:p-6 rounded-3xl w-full max-w-md relative flex flex-col max-h-[85vh]">
                     <div className="flex justify-between items-center mb-5 sm:mb-6">
                         <h2 className="text-lg sm:text-xl font-bold flex items-center gap-2 text-slate-700"><Settings className="w-5 h-5 sm:w-6 sm:h-6" /> Pengaturan</h2>
                         <button onClick={() => setShowSettingsModal(false)} className="bg-slate-100 p-1 rounded-full text-slate-600 hover:bg-slate-200"><X className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                     </div>

                     <div className="overflow-y-auto flex-1 pr-2 custom-scrollbar space-y-5 sm:space-y-6">
                         <div className="space-y-2 sm:space-y-3">
                            <h3 className="text-xs sm:text-sm font-bold text-slate-800 uppercase tracking-wider border-b border-slate-100 pb-2 flex items-center gap-2">
                                <Database className="w-3 h-3 sm:w-4 sm:h-4 text-orange-500" /> Sinkronisasi Backup
                            </h3>
                            <div>
                               <label className="block text-[10px] sm:text-xs font-bold text-slate-500 uppercase mb-1.5 sm:mb-2">Google Apps Script URL</label>
                               <input type="text" value={scriptUrl} onChange={(e) => saveScriptUrl(e.target.value)} placeholder="https://script.google.com/..." className="w-full px-3 py-2.5 sm:px-4 sm:py-3 rounded-xl border border-slate-200 text-xs sm:text-sm focus:border-orange-500 outline-none" />
                            </div>
                         </div>

                         <div className="space-y-2 sm:space-y-3">
                            <h3 className="text-xs sm:text-sm font-bold text-slate-800 uppercase tracking-wider border-b border-slate-100 pb-2">Data Kelas Global</h3>
                            <form onSubmit={handleAddClass} className="flex gap-2">
                              <input type="text" value={classForm} onChange={(e) => setClassForm(e.target.value)} className="flex-1 px-3 py-2 sm:px-4 sm:py-2.5 rounded-xl border border-slate-200 text-xs sm:text-sm focus:border-orange-500 outline-none" placeholder="Nama Kelas Baru..." />
                              <button type="submit" disabled={!classForm.trim()} className="bg-orange-600 hover:bg-orange-700 disabled:bg-slate-300 text-white px-3 sm:px-4 py-2 sm:py-2.5 rounded-xl font-bold transition-all"><PlusCircle className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                            </form>
                            <div className="space-y-1.5 sm:space-y-2">
                              {(Array.isArray(classes) ? classes : []).map((cls, idx) => (
                                <div key={idx} className="flex items-center justify-between p-2.5 sm:p-3 bg-slate-50 rounded-xl border border-slate-100">
                                  {editingClassIdx === idx ? (
                                    <div className="flex gap-2 w-full">
                                       <input type="text" value={editClassText} onChange={(e) => setEditClassText(e.target.value)} className="flex-1 px-2 py-1.5 text-xs sm:text-sm border rounded focus:outline-none focus:border-orange-500" autoFocus />
                                       <button onClick={() => saveClassEdit(idx)} className="text-green-600 p-1 bg-green-50 rounded"><Check className="w-4 h-4" /></button>
                                       <button onClick={cancelEditClass} className="text-red-500 p-1 bg-red-50 rounded"><X className="w-4 h-4" /></button>
                                    </div>
                                  ) : (
                                    <>
                                      <span className="font-semibold text-slate-700 text-xs sm:text-sm">{cls}</span>
                                      <div className="flex gap-1.5 sm:gap-2">
                                        <button onClick={() => startEditingClass(idx)} className="p-1.5 sm:p-2 text-slate-400 hover:text-orange-600 hover:bg-orange-50 rounded"><Pencil className="w-3.5 h-3.5 sm:w-4 sm:h-4" /></button>
                                        <button onClick={() => setDeleteConfig({ show: true, type: 'class', name: cls })} className="p-1.5 sm:p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded"><Trash2 className="w-3.5 h-3.5 sm:w-4 sm:h-4" /></button>
                                      </div>
                                    </>
                                  )}
                                </div>
                              ))}
                            </div>
                         </div>
                     </div>

                     <div className="mt-5 sm:mt-6 pt-4 border-t border-slate-100">
                        <button onClick={() => setShowSettingsModal(false)} className="w-full bg-orange-600 text-white font-bold py-2.5 sm:py-3 rounded-xl shadow-lg hover:bg-orange-700 transition-all text-sm sm:text-base">Selesai</button>
                     </div>
                  </div>
                </div>
              )}

              {showVerseModal && activeSurahForPicker && (
                <div className="fixed inset-0 z-[120] flex items-center justify-center bg-black/60 backdrop-blur-md p-4 animate-in zoom-in">
                    <div className="bg-white p-5 sm:p-6 rounded-3xl shadow-2xl w-full max-w-sm relative text-center">
                        <button onClick={() => setShowVerseModal(false)} className="absolute top-4 right-4 text-slate-400"><X className="w-4 h-4 sm:w-5 sm:h-5"/></button>
                        <h3 className="text-base sm:text-lg font-bold mb-4">Ayat: {activeSurahForPicker.name}</h3>
                        <div className="flex items-center gap-2 sm:gap-3 mb-5 sm:mb-6">
                            <input ref={startVerseRef} type="number" value={verseInput.start} onChange={(e) => handleVerseInputChange('start', e.target.value)} className="w-full px-3 py-2.5 sm:px-4 sm:py-3 rounded-xl border text-center text-base sm:text-lg outline-none focus:border-orange-500" placeholder="1" />
                            <span className="font-bold text-slate-400">-</span>
                            <input type="number" value={verseInput.end} onChange={(e) => handleVerseInputChange('end', e.target.value)} className="w-full px-3 py-2.5 sm:px-4 sm:py-3 rounded-xl border text-center text-base sm:text-lg outline-none focus:border-orange-500" placeholder={activeSurahForPicker.ayahs} />
                        </div>
                        <div className="space-y-2 sm:space-y-3">
                            <button onClick={() => saveVerseSelection(false)} className="w-full bg-orange-600 text-white font-bold py-2.5 sm:py-3 rounded-xl text-sm sm:text-base">Simpan</button>
                            <button onClick={() => saveVerseSelection(true)} className="w-full bg-orange-50 text-orange-700 font-bold py-2.5 sm:py-3 rounded-xl text-sm sm:text-base">Full Surat</button>
                        </div>
                    </div>
                </div>
              )}

              {showManageStudentModal && isAdmin && (
                <div className="fixed inset-0 z-[160] flex items-center justify-center bg-black/50 p-4 animate-in fade-in">
                  <div className="bg-white p-5 sm:p-6 rounded-3xl w-full max-w-md relative flex flex-col max-h-[80vh]">
                    <div className="flex justify-between items-center mb-5 sm:mb-6">
                      <h2 className="text-base sm:text-lg font-bold flex items-center gap-2"><UserCog className="w-4 h-4 sm:w-5 sm:h-5 text-orange-600" /> Kelola Siswa</h2>
                      <button onClick={() => setShowManageStudentModal(false)} className="bg-slate-100 p-1.5 rounded-full"><X className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                    </div>
                    <form onSubmit={handleAddStudent} className="flex gap-2 mb-4">
                      <input type="text" value={newStudentName} onChange={(e) => setNewStudentName(e.target.value)} className="flex-1 px-3 py-2 sm:px-4 sm:py-2.5 rounded-xl border border-slate-200 focus:border-orange-500 outline-none text-xs sm:text-sm" placeholder="Nama Baru..." />
                      <button className="bg-orange-600 text-white px-3 sm:px-4 rounded-xl font-bold"><PlusCircle className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                    </form>
                    <div className="overflow-y-auto flex-1 pr-1 custom-scrollbar space-y-1.5 sm:space-y-2">
                      {(Array.isArray(selectedHalaqoh?.students) ? selectedHalaqoh.students : []).map((student, idx) => (
                        <div key={idx} className="flex items-center justify-between p-2.5 sm:p-3 bg-slate-50 rounded-xl border border-slate-100">
                          {editingStudentIndex === idx ? (
                            <div className="flex gap-2 w-full">
                               <input type="text" value={editStudentValue} onChange={(e) => setEditStudentValue(e.target.value)} className="flex-1 px-2 py-1.5 text-xs sm:text-sm border rounded focus:outline-none focus:border-orange-500" autoFocus />
                               <button onClick={() => saveEditStudent(idx)} className="text-green-600 p-1 bg-green-50 rounded"><Check className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                               <button onClick={() => setEditingStudentIndex(null)} className="text-red-500 p-1 bg-red-50 rounded"><X className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                            </div>
                          ) : (
                            <>
                              <span className="font-semibold text-slate-700 text-xs sm:text-sm truncate">{student}</span>
                              <div className="flex gap-1 flex-shrink-0">
                                <button onClick={() => handleMoveStudent(idx, 'up')} disabled={idx === 0} className={`p-1.5 rounded ${idx === 0 ? 'text-slate-200' : 'text-slate-400 hover:text-orange-600 hover:bg-orange-50'}`}><ArrowUp className="w-3.5 h-3.5 sm:w-4 sm:h-4" /></button>
                                <button onClick={() => handleMoveStudent(idx, 'down')} disabled={idx === selectedHalaqoh.students.length - 1} className={`p-1.5 rounded ${idx === selectedHalaqoh.students.length - 1 ? 'text-slate-200' : 'text-slate-400 hover:text-orange-600 hover:bg-orange-50'}`}><ArrowDown className="w-3.5 h-3.5 sm:w-4 sm:h-4" /></button>
                                <div className="w-px h-4 bg-slate-200 mx-0.5 sm:mx-1 self-center"></div>
                                <button onClick={() => startEditingStudent(idx)} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded"><Pencil className="w-3.5 h-3.5 sm:w-4 sm:h-4" /></button>
                                <button onClick={() => setDeleteConfig({ show: true, type: 'student', name: student })} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded"><Trash2 className="w-3.5 h-3.5 sm:w-4 sm:h-4" /></button>
                              </div>
                            </>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {/* MODAL EDIT HISTORY ADMIN */}
              {showEditHistoryModal && editingHistoryItem && isAdmin && (
                <div className="fixed inset-0 z-[180] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in">
                   <div className="bg-white p-5 sm:p-6 rounded-3xl w-full max-w-sm flex flex-col max-h-[90vh]">
                      <div className="flex justify-between items-center mb-4 border-b border-slate-100 pb-3 flex-shrink-0">
                          <h2 className="text-base sm:text-lg font-bold flex items-center gap-2 text-slate-800"><Pencil className="w-4 h-4 sm:w-5 sm:h-5 text-orange-600"/> Edit Riwayat</h2>
                          <button onClick={() => { setShowEditHistoryModal(false); setEditingHistoryItem(null); }} className="text-slate-400 hover:text-slate-600"><X className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                      </div>
                      <div className="overflow-y-auto custom-scrollbar pr-1 flex-1 pb-2">
                          <form id="editHistoryForm" onSubmit={handleSaveHistoryEdit} className="space-y-4">
                             <div>
                                <label className="text-[9px] sm:text-[10px] font-bold text-slate-400 uppercase mb-1 block">Nama Siswa</label>
                                <input type="text" value={editingHistoryItem.student || ''} onChange={e => setEditingHistoryItem({...editingHistoryItem, student: e.target.value})} className="w-full px-3 py-2 sm:py-2.5 rounded-xl border border-slate-200 text-xs sm:text-sm focus:border-orange-500 outline-none" required />
                             </div>
                             <div>
                                <label className="text-[9px] sm:text-[10px] font-bold text-slate-400 uppercase mb-1 block">Kelas</label>
                                <select value={editingHistoryItem.class || ''} onChange={e => setEditingHistoryItem({...editingHistoryItem, class: e.target.value})} className="w-full px-3 py-2 sm:py-2.5 rounded-xl border border-slate-200 text-xs sm:text-sm focus:border-orange-500 outline-none bg-white">
                                    {(Array.isArray(classes) ? classes : []).map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                             </div>
                             <div>
                                <label className="text-[9px] sm:text-[10px] font-bold text-slate-400 uppercase mb-1 block">Waktu Setoran (WIB)</label>
                                <input type="datetime-local" value={formatForDatetimeInput(editingHistoryItem.date)} onChange={e => setEditingHistoryItem({...editingHistoryItem, date: new Date(e.target.value).toISOString()})} className="w-full px-3 py-2 sm:py-2.5 rounded-xl border border-slate-200 text-xs sm:text-sm focus:border-orange-500 outline-none" required />
                             </div>
                             <div className="pt-3 border-t border-slate-100">
                                <label className="text-[9px] sm:text-[10px] font-bold text-slate-400 uppercase mb-2 block">Surat & Ayat yang Disetorkan</label>
                                <div className="space-y-2 mb-3">
                                  {(Array.isArray(editingHistoryItem.surahs) ? editingHistoryItem.surahs : []).map(num => (
                                    <div key={num} className="flex items-center gap-2 bg-slate-50 p-2 rounded-xl border border-slate-200 shadow-sm transition-all">
                                      <span className="flex-1 text-[10px] sm:text-xs font-bold text-slate-700 truncate">{getSurahName(num)}</span>
                                      <input type="text" placeholder="Ayat..." value={editingHistoryItem.ranges?.[num] || ''} onChange={(e) => { const newRanges = { ...(editingHistoryItem.ranges || {}) }; if (e.target.value) { newRanges[num] = e.target.value; } else { delete newRanges[num]; } setEditingHistoryItem({ ...editingHistoryItem, ranges: newRanges }); }} className="w-16 sm:w-20 lg:w-24 px-2 py-1 sm:py-1.5 text-[9px] sm:text-[10px] md:text-xs rounded-lg border border-slate-300 focus:border-orange-500 outline-none bg-white" />
                                      <button type="button" onClick={() => { const newSurahs = (Array.isArray(editingHistoryItem.surahs) ? editingHistoryItem.surahs : []).filter(s => s !== num); const newRanges = { ...(editingHistoryItem.ranges || {}) }; delete newRanges[num]; setEditingHistoryItem({ ...editingHistoryItem, surahs: newSurahs, ranges: newRanges }); }} className="text-red-400 hover:text-red-600 p-1 sm:p-1.5 bg-white hover:bg-red-50 rounded-lg border border-slate-200 shadow-sm transition-colors"><X className="w-3 h-3 sm:w-3.5 sm:h-3.5" /></button>
                                    </div>
                                  ))}
                                  {(!Array.isArray(editingHistoryItem.surahs) || editingHistoryItem.surahs.length === 0) && (<div className="text-[9px] sm:text-[10px] text-red-500 italic text-center bg-red-50 py-2 rounded-lg border border-red-100">Siswa harus menyetorkan minimal 1 surat!</div>)}
                                </div>
                                <select className="w-full px-3 py-2 text-[10px] sm:text-xs rounded-xl border border-dashed border-orange-300 outline-none bg-orange-50 text-orange-700 font-semibold cursor-pointer appearance-none text-center" value="" onChange={(e) => { const num = parseInt(e.target.value); const safeSurahs = Array.isArray(editingHistoryItem.surahs) ? editingHistoryItem.surahs : []; if (num && !safeSurahs.includes(num)) { setEditingHistoryItem({ ...editingHistoryItem, surahs: [...safeSurahs, num].sort((a,b) => a - b) }); } }}>
                                  <option value="" disabled>+ Tambah Surat Baru...</option>
                                  {SURAH_LIST.filter(s => !(Array.isArray(editingHistoryItem?.surahs) ? editingHistoryItem.surahs : []).includes(s.number)).map(s => (<option key={s.number} value={s.number} className="text-left text-slate-700">{s.number}. {s.name}</option>))}
                                </select>
                             </div>
                          </form>
                      </div>
                      <div className="flex gap-2 pt-4 border-t border-slate-100 flex-shrink-0">
                         <button type="button" onClick={() => { setShowEditHistoryModal(false); setEditingHistoryItem(null); }} className="flex-1 py-2.5 sm:py-3 bg-slate-100 hover:bg-slate-200 transition-colors rounded-xl text-xs sm:text-sm font-bold text-slate-600">Batal</button>
                         <button form="editHistoryForm" type="submit" disabled={isLoading || !Array.isArray(editingHistoryItem.surahs) || editingHistoryItem.surahs.length === 0} className="flex-[1.5] py-2.5 sm:py-3 bg-orange-600 hover:bg-orange-700 transition-colors text-white rounded-xl text-xs sm:text-sm font-bold flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                             {isLoading ? <Loader2 className="w-3 h-3 sm:w-4 sm:h-4 animate-spin" /> : "Simpan Perubahan"}
                         </button>
                      </div>
                   </div>
                </div>
              )}

              {/* MODAL SHARE GAMBAR PRESTASI */}
              {shareItem && (() => {
                  const studentHistory = (Array.isArray(history) ? history : []).filter(h => h?.student === shareItem?.student).sort((a, b) => new Date(a?.date || 0) - new Date(b?.date || 0));
                  const submissionIndex = studentHistory.findIndex(h => h?.id === shareItem?.id);
                  const submissionCount = submissionIndex + 1; 
                  const effectiveCount = submissionCount % 60 === 0 && submissionCount > 0 ? 60 : submissionCount % 60;
                  let theme = { overlay: "from-white/95 via-white/80 to-orange-50/90", title: "text-orange-600", badgeBg: "bg-orange-50", badgeText: "text-orange-700", badgeBorder: "border-orange-100", dot: "text-orange-500", footerValue: "text-orange-600", isSpecial: false };
                  if (effectiveCount >= 10 && effectiveCount < 20) theme = { overlay: "from-green-100 via-white/90 to-green-50/90", title: "text-green-700", badgeBg: "bg-green-100", badgeText: "text-green-800", badgeBorder: "border-green-300", dot: "text-green-500", footerValue: "text-green-700", isSpecial: true };
                  else if (effectiveCount >= 20 && effectiveCount < 30) theme = { overlay: "from-blue-100 via-white/90 to-blue-50/90", title: "text-blue-700", badgeBg: "bg-blue-100", badgeText: "text-blue-800", badgeBorder: "border-blue-300", dot: "text-blue-500", footerValue: "text-blue-700", isSpecial: true };
                  else if (effectiveCount >= 30 && effectiveCount < 40) theme = { overlay: "from-red-100 via-white/90 to-red-50/90", title: "text-red-700", badgeBg: "bg-red-100", badgeText: "text-red-800", badgeBorder: "border-red-300", dot: "text-red-500", footerValue: "text-red-700", isSpecial: true };
                  else if (effectiveCount >= 40 && effectiveCount < 50) theme = { overlay: "from-purple-100 via-white/90 to-purple-50/90", title: "text-purple-700", badgeBg: "bg-purple-100", badgeText: "text-purple-800", badgeBorder: "border-purple-300", dot: "text-purple-500", footerValue: "text-purple-700", isSpecial: true };
                  else if (effectiveCount >= 50 && effectiveCount < 60) theme = { overlay: "from-slate-300 via-white/90 to-slate-200/90", title: "text-slate-800", badgeBg: "bg-slate-200", badgeText: "text-slate-800", badgeBorder: "border-slate-400", dot: "text-slate-600", footerValue: "text-slate-800", isSpecial: true };
                  else if (effectiveCount === 60) theme = { overlay: "from-yellow-200 via-white/90 to-yellow-100/90", title: "text-yellow-700", badgeBg: "bg-yellow-200", badgeText: "text-yellow-900", badgeBorder: "border-yellow-400", dot: "text-yellow-600", footerValue: "text-yellow-700", isSpecial: true };

                  return (
                     <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur-md p-4 animate-in fade-in">
                        <div className="w-full max-w-sm flex flex-col items-center">
                           <div className="max-w-full overflow-x-auto pb-4 custom-scrollbar">
                               <div ref={shareCardRef} className="w-[320px] h-[400px] bg-white rounded-none p-6 text-slate-800 relative overflow-hidden flex flex-col items-center text-center mx-auto border border-slate-200 shadow-2xl" style={{ boxSizing: 'border-box', flexShrink: 0 }}>
                                  <div className="absolute inset-0 z-0"><img src="https://images.unsplash.com/photo-1609599006353-e629aaabfeae?q=80&w=800&auto=format&fit=crop" crossOrigin="anonymous" alt="Quran Background" className="w-full h-full object-cover opacity-30" /><div className={`absolute inset-0 bg-gradient-to-b ${theme.overlay}`}></div></div>
                                  {theme.isSpecial && (<div className="absolute top-4 right-4 rotate-12 z-20"><div className={`px-2.5 py-1 rounded-full font-black text-[9px] shadow-md border ${theme.badgeBg} ${theme.badgeText} ${theme.badgeBorder} uppercase tracking-wider`}>‚≠ê Setoran ke-{submissionCount}</div></div>)}
                                  <div className="relative z-10 flex flex-col items-center text-center w-full h-full">
                                     <img src="./logo.png" onError={(e) => { e.target.style.display = 'none'; }} alt="Logo" className="h-5 max-w-[80%] mb-2 object-contain" />
                                     <h3 className={`text-xl font-bold ${theme.title} leading-tight`}>Jurnal Murojaahku</h3>
                                     <p className="text-[10px] font-bold tracking-widest text-slate-500 uppercase mb-4">SDIT Al Fityan School Bogor</p>
                                     <h2 className="text-2xl font-bold text-slate-800 mb-0.5">{shareItem.student || 'Siswa'}</h2>
                                     <div className="flex justify-center mb-4"><span className={`${theme.title} text-[10px] font-bold uppercase tracking-widest`}>{shareItem.class || '-'}</span></div>
                                     <p className="text-xs text-slate-600 mb-2 italic">Alhamdulillah telah memurojaah hafalan :</p>
                                     {(() => {
                                        const safeSurahs = Array.isArray(shareItem.surahs) ? shareItem.surahs : [];
                                        const count = safeSurahs.length;
                                        let textSizeClass = 'text-sm'; let spanSizeClass = 'text-[10px]'; let gapClass = 'gap-2'; let dotMargin = 'ml-2';
                                        if (count > 25) { textSizeClass = 'text-[7px]'; spanSizeClass = 'text-[6px]'; gapClass = 'gap-0.5'; dotMargin = 'ml-0.5'; } 
                                        else if (count > 15) { textSizeClass = 'text-[8px]'; spanSizeClass = 'text-[7px]'; gapClass = 'gap-1'; dotMargin = 'ml-1'; } 
                                        else if (count > 8) { textSizeClass = 'text-[10px]'; spanSizeClass = 'text-[8px]'; gapClass = 'gap-1.5'; dotMargin = 'ml-1.5'; } 
                                        else if (count > 4) { textSizeClass = 'text-xs'; spanSizeClass = 'text-[9px]'; gapClass = 'gap-2'; dotMargin = 'ml-2'; }
                                        return (
                                            <div className={`w-full bg-transparent p-2 mb-4 flex-1 flex flex-wrap justify-center content-center items-center ${gapClass} overflow-hidden`}>
                                            {safeSurahs.map((num, index) => {
                                                const namaSurat = getSurahName(num);
                                                const rentang = shareItem?.ranges?.[num];
                                                return (
                                                    <div key={num} className={`text-slate-800 ${textSizeClass} font-bold leading-tight flex items-baseline`}>
                                                        <span>{namaSurat}</span>
                                                        {rentang && <span className={`font-normal text-slate-600 ml-0.5 ${spanSizeClass}`}>({rentang})</span>}
                                                        {index < count - 1 && <span className={`${theme.dot} ${dotMargin} font-black`}>‚Ä¢</span>}
                                                    </div>
                                                )
                                            })}
                                            </div>
                                        );
                                     })()}
                                     <div className="w-full flex justify-between items-end text-[9px] text-slate-500 border-t border-slate-300 pt-4 pb-1 mt-auto">
                                        <div className="text-left flex flex-col gap-0.5"><p>Halaqoh :</p><p className={`font-bold ${theme.footerValue} text-xs leading-tight`}>{shareItem.halaqohName || '-'}</p></div>
                                        <div className="text-right"><p>{getDateOnly(shareItem?.date || new Date().toISOString())}</p></div>
                                     </div>
                                  </div>
                               </div>
                           </div>
                           <div className="flex gap-2 mt-2 w-full max-w-[320px]">
                              <button onClick={() => setShareItem(null)} className="flex-[0.8] py-2.5 sm:py-3 bg-white/10 hover:bg-white/20 text-white rounded-xl font-bold transition text-xs sm:text-sm">Tutup</button>
                              <button onClick={() => processImage('download')} disabled={!!isGeneratingImage} className="flex-[1.2] py-2.5 sm:py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-700 transition shadow-lg flex items-center justify-center gap-1.5 text-xs sm:text-sm border border-slate-700">{isGeneratingImage === 'download' ? <Loader2 className="w-4 h-4 sm:w-5 sm:h-5 animate-spin" /> : <Download className="w-4 h-4 sm:w-5 sm:h-5" />} Unduh</button>
                              <button onClick={() => processImage('share')} disabled={!!isGeneratingImage} className="flex-[1.2] py-2.5 sm:py-3 bg-white text-blue-600 rounded-xl font-bold hover:bg-blue-50 transition shadow-lg flex items-center justify-center gap-1.5 text-xs sm:text-sm">{isGeneratingImage === 'share' ? <Loader2 className="w-4 h-4 sm:w-5 sm:h-5 animate-spin" /> : <Share2 className="w-4 h-4 sm:w-5 sm:h-5" />} Share</button>
                           </div>
                        </div>
                     </div>
                  );
              })()}

              {/* MODAL SHARE KARTU HALAQOH */}
              {shareHalaqohItem && (() => {
                  const safeStudents = Array.isArray(shareHalaqohItem.students) ? shareHalaqohItem.students : [];
                  const count = safeStudents.length;
                  const hNameLen = (shareHalaqohItem?.name || '').length;
                  let titleClass = "text-xl"; let subTitleClass = "text-[10px] mb-4"; let hNameClass = hNameLen > 20 ? "text-xl mb-0.5" : "text-2xl mb-0.5"; let uNameClass = "text-[10px] mb-4"; let labelClass = "text-xs mb-2"; let studentTextClass = "text-sm leading-relaxed"; let dotClass = "mx-2 text-base"; let footerClass = "pt-2.5 pb-0.5 text-[9px]";
                  if (count > 30) { titleClass = "text-sm"; subTitleClass = "text-[7px] mb-1"; hNameClass = hNameLen > 20 ? "text-xs mb-0" : "text-sm mb-0"; uNameClass = "text-[7px] mb-1"; labelClass = "text-[8px] mb-1"; studentTextClass = "text-[7px] leading-tight"; dotClass = "mx-1 text-[7px]"; footerClass = "pt-1.5 pb-0 text-[7px]"; } 
                  else if (count > 20) { titleClass = "text-base"; subTitleClass = "text-[8px] mb-1.5"; hNameClass = hNameLen > 20 ? "text-sm mb-0" : "text-base mb-0"; uNameClass = "text-[8px] mb-1.5"; labelClass = "text-[9px] mb-1"; studentTextClass = "text-[8.5px] leading-tight"; dotClass = "mx-1 text-[8.5px]"; footerClass = "pt-1.5 pb-0 text-[8px]"; } 
                  else if (count > 12) { titleClass = "text-lg"; subTitleClass = "text-[9px] mb-2"; hNameClass = hNameLen > 20 ? "text-base mb-0.5" : "text-lg mb-0.5"; uNameClass = "text-[9px] mb-2"; labelClass = "text-[10px] mb-1"; studentTextClass = "text-[10px] leading-snug"; dotClass = "mx-1 text-[10px]"; footerClass = "pt-2 pb-0 text-[8.5px]"; } 
                  else if (count > 6) { titleClass = "text-xl"; subTitleClass = "text-[10px] mb-3"; hNameClass = hNameLen > 20 ? "text-lg mb-0.5" : "text-xl mb-0.5"; uNameClass = "text-[10px] mb-3"; labelClass = "text-[11px] mb-2"; studentTextClass = "text-xs leading-snug"; dotClass = "mx-1.5 text-xs"; footerClass = "pt-2 pb-0 text-[9px]"; }

                  return (
                     <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur-md p-4 animate-in fade-in">
                        <div className="w-full max-w-sm flex flex-col items-center">
                           <div className="max-w-full overflow-x-auto pb-4 custom-scrollbar">
                               <div ref={shareHalaqohCardRef} className="w-[320px] h-[400px] bg-white rounded-none pt-6 px-6 pb-3 text-slate-800 relative overflow-hidden flex flex-col items-center text-center mx-auto border border-slate-200 shadow-2xl" style={{ boxSizing: 'border-box', flexShrink: 0 }}>
                                  <div className="absolute inset-0 z-0"><img src="https://images.unsplash.com/photo-1609599006353-e629aaabfeae?q=80&w=800&auto=format&fit=crop" crossOrigin="anonymous" alt="Quran Background" className="w-full h-full object-cover opacity-30" /><div className="absolute inset-0 bg-gradient-to-b from-blue-100 via-white/90 to-blue-50/90"></div></div>
                                  <div className="relative z-10 flex flex-col items-center text-center w-full h-full">
                                     <img src="./logo.png" onError={(e) => { e.target.style.display = 'none'; }} alt="Logo" className={`h-5 max-w-[80%] mb-1 object-contain ${count > 25 ? 'mb-0.5' : 'mb-2'}`} />
                                     <h3 className={`font-bold text-blue-700 leading-tight ${titleClass}`}>Jurnal Murojaahku</h3>
                                     <p className={`font-bold tracking-widest text-slate-500 uppercase ${subTitleClass}`}>SDIT Al Fityan School Bogor</p>
                                     <h2 className={`font-bold text-slate-800 break-words px-2 leading-tight ${hNameClass}`}>{shareHalaqohItem?.name || '-'}</h2>
                                     <div className={`flex justify-center w-full px-2 ${uNameClass}`}><span className="text-blue-700 font-bold uppercase tracking-widest break-words mt-0.5">{shareHalaqohItem?.ustadzName || '-'}</span></div>
                                     <p className={`text-slate-600 italic ${labelClass}`}>Daftar Nama Siswa :</p>
                                     <div className="w-full bg-transparent p-1 mb-2 flex-1 flex flex-col justify-center overflow-hidden">
                                        <p className={`w-full text-center text-slate-800 font-bold break-words ${studentTextClass}`}>
                                            {safeStudents.map((siswa, index) => (
                                                <React.Fragment key={index}>
                                                    {siswa}
                                                    {index < count - 1 && (<span className={`text-blue-500 font-black inline-block ${dotClass}`}>‚Ä¢</span>)}
                                                </React.Fragment>
                                            ))}
                                        </p>
                                     </div>
                                     <div className={`w-full text-center text-slate-600 border-t border-slate-300 mt-auto italic font-medium px-1 whitespace-nowrap tracking-tight ${footerClass}`}>"Membangun Generasi Qurani dan Pemimpin Masa Depan"</div>
                                  </div>
                               </div>
                           </div>
                           <div className="flex gap-2 mt-2 w-full max-w-[320px]">
                              <button onClick={() => setShareHalaqohItem(null)} className="flex-[0.8] py-2.5 sm:py-3 bg-white/10 hover:bg-white/20 text-white rounded-xl font-bold transition text-xs sm:text-sm">Tutup</button>
                              <button onClick={() => processHalaqohImage('download')} disabled={!!isGeneratingImage} className="flex-[1.2] py-2.5 sm:py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-700 transition shadow-lg flex items-center justify-center gap-1.5 text-xs sm:text-sm border border-slate-700">{isGeneratingImage === 'download' ? <Loader2 className="w-4 h-4 sm:w-5 sm:h-5 animate-spin" /> : <Download className="w-4 h-4 sm:w-5 sm:h-5" />} Unduh</button>
                              <button onClick={() => processHalaqohImage('share')} disabled={!!isGeneratingImage} className="flex-[1.2] py-2.5 sm:py-3 bg-white text-blue-600 rounded-xl font-bold hover:bg-blue-50 transition shadow-lg flex items-center justify-center gap-1.5 text-xs sm:text-sm">{isGeneratingImage === 'share' ? <Loader2 className="w-4 h-4 sm:w-5 sm:h-5 animate-spin" /> : <Share2 className="w-4 h-4 sm:w-5 sm:h-5" />} Share</button>
                           </div>
                        </div>
                     </div>
                  );
              })()}

              {/* TAMPILAN GRID USTADZ */}
              {currentView === 'select-ustadz' && currentView !== 'welcome' && (
                <>
                  {HeaderUI("Pilih Pengajar", "Siapa yang mengampu halaqoh?")}
                  <div className="max-w-xl mx-auto p-3 sm:p-4 pb-24"> 
                    {isAdmin && (
                      <div onClick={openAddUstadz} className="mb-3 sm:mb-4 bg-orange-100 border-2 border-dashed border-orange-300 p-3 sm:p-4 rounded-xl flex items-center justify-center gap-2 cursor-pointer hover:bg-orange-200 transition-colors">
                         <PlusCircle className="text-orange-600 w-5 h-5 sm:w-6 sm:h-6" />
                         <span className="font-bold text-orange-700 text-sm sm:text-base">Tambah Pengajar Baru</span>
                      </div>
                    )}
                    
                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-2.5 sm:gap-4">
                        {(!Array.isArray(sortedUstadzData) || sortedUstadzData.length === 0) ? (
                            <div className="col-span-2 sm:col-span-3 text-center py-10">
                                <p className="text-slate-500 mb-4">Daftar pengajar tidak ditemukan.</p>
                                <button onClick={() => { setData(INITIAL_DATA); localStorage.removeItem('murojaahData'); }} className="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-xl font-bold transition-all shadow-lg">Pulihkan Data Awal</button>
                            </div>
                        ) : (
                            sortedUstadzData.map((u, index) => {
                              const safeData = Array.isArray(data) ? data : [];
                              const originalIdx = safeData.findIndex(orig => orig?.id === u?.id);
                              
                              return (
                                  <div key={u?.id || index} onClick={() => handleSelectUstadz(u)} className="bg-white p-3 sm:p-4 rounded-2xl shadow-sm border border-slate-100 hover:border-orange-300 hover:shadow-md transition-all flex flex-col items-center text-center group relative cursor-pointer h-full">
                                    <div className={`w-12 h-12 sm:w-14 sm:h-14 rounded-full flex items-center justify-center mb-2 sm:mb-3 flex-shrink-0 shadow-inner ${u?.gender === 'male' ? 'bg-gradient-to-br from-blue-50 to-blue-100 text-blue-600' : 'bg-gradient-to-br from-pink-50 to-pink-100 text-pink-600'}`}>
                                        <User className="w-6 h-6 sm:w-7 sm:h-7" />
                                    </div>
                                    <div className="flex-1 w-full flex flex-col items-center">
                                        <h3 className="font-bold text-[11px] sm:text-sm text-slate-800 w-full line-clamp-2 leading-tight mb-1.5 min-h-[32px] flex items-center justify-center">{u?.name || "Tanpa Nama"}</h3>
                                        <div className="flex flex-col items-center gap-1 mt-auto">
                                            <span className="text-[9px] sm:text-[10px] font-medium text-slate-500 bg-slate-50 px-2 py-0.5 rounded-full border border-slate-100">
                                                {(Array.isArray(u?.halaqohs) ? u.halaqohs : []).length} Halaqoh
                                            </span>
                                        </div>
                                    </div>
                                    {isAdmin && (
                                      <div className="flex gap-0.5 items-center justify-center w-full mt-3 pt-2.5 border-t border-slate-100" onClick={e=>e.stopPropagation()}>
                                        <button onClick={() => handleMoveUstadz(originalIdx, 'up')} disabled={originalIdx <= 0} className={`p-1.5 rounded-lg ${originalIdx <= 0 ? 'text-slate-200' : 'text-slate-400 hover:text-orange-600 hover:bg-orange-50'}`}><ArrowUp className="w-3.5 h-3.5 sm:w-4 sm:h-4" /></button>
                                        <button onClick={() => handleMoveUstadz(originalIdx, 'down')} disabled={originalIdx >= safeData.length - 1} className={`p-1.5 rounded-lg ${originalIdx >= safeData.length - 1 ? 'text-slate-200' : 'text-slate-400 hover:text-orange-600 hover:bg-orange-50'}`}><ArrowDown className="w-3.5 h-3.5 sm:w-4 sm:h-4" /></button>
                                        <div className="w-px h-3 sm:h-4 bg-slate-200 mx-0.5"></div>
                                        <button onClick={(e) => openEditUstadz(e, u)} className="p-1.5 text-orange-600 hover:bg-orange-50 rounded-lg"><Pencil className="w-3.5 h-3.5 sm:w-4 sm:h-4"/></button>
                                        <button onClick={(e) => handleDeleteUstadzReq(e, u)} className="p-1.5 text-red-600 hover:bg-red-50 rounded-lg"><Trash2 className="w-3.5 h-3.5 sm:w-4 sm:h-4"/></button>
                                      </div>
                                    )}
                                  </div>
                              );
                            })
                        )}
                    </div>
                  </div>
                </>
              )}

              {currentView === 'select-halaqoh' && (
                <>
                  {HeaderUI("Pilih Halaqoh", `Daftar Halaqoh ${selectedUstadz?.name || ''}`)}
                  <div className="max-w-xl mx-auto p-3 sm:p-4 grid gap-2.5 sm:gap-3 pb-24"> 
                    {isAdmin && (
                      <div onClick={openAddHalaqoh} className="bg-orange-100 border-2 border-dashed border-orange-300 p-3 sm:p-4 rounded-2xl flex items-center justify-center gap-2 cursor-pointer hover:bg-orange-200 transition-colors">
                         <PlusCircle className="text-orange-600 w-4 h-4 sm:w-5 sm:h-5" />
                         <span className="font-bold text-orange-700 text-sm sm:text-base">Tambah Halaqoh Baru</span>
                      </div>
                    )}

                    {(Array.isArray(selectedUstadz?.halaqohs) ? selectedUstadz.halaqohs : []).map((h, hIdx) => (
                      <div key={h?.id || hIdx} onClick={() => handleSelectHalaqoh(h)} className="bg-white p-4 sm:p-5 rounded-2xl shadow-sm border border-slate-100 hover:border-orange-300 hover:shadow-md transition-all group cursor-pointer relative overflow-hidden">
                        <div className="flex items-start gap-3 sm:gap-4">
                            <div className="w-10 h-10 sm:w-12 sm:h-12 rounded-2xl flex items-center justify-center bg-gradient-to-br from-orange-100 to-orange-50 text-orange-600 flex-shrink-0 shadow-inner">
                                <Users className="w-5 h-5 sm:w-6 sm:h-6" />
                            </div>

                            <div className="flex-1 min-w-0">
                                <div className="flex justify-between items-start">
                                    <div className="overflow-hidden">
                                        <h3 className="font-bold text-base sm:text-lg text-slate-800 leading-tight mb-1 group-hover:text-orange-700 transition-colors truncate">{h?.name || "Tanpa Nama"}</h3>
                                        <div className="inline-flex items-center gap-1.5">
                                            <span className="h-1.5 w-1.5 sm:h-2 sm:w-2 rounded-full bg-green-500 animate-pulse"></span>
                                            <span className="text-[9px] sm:text-[11px] font-bold text-slate-500 bg-slate-50 px-1.5 sm:px-2 py-0.5 rounded-full border border-slate-100">
                                                {(Array.isArray(h?.students) ? h.students : []).length} Siswa Terdata
                                            </span>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-1 flex-shrink-0" onClick={e => e.stopPropagation()}>
                                        <button onClick={(e) => handleShareHalaqohClick(e, h)} className="p-1.5 sm:p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors" title="Bagikan Kartu Kelompok"><ImageIcon className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                                        {isAdmin ? (
                                            <>
                                                <button onClick={(e) => openEditHalaqoh(e, h)} className="p-1.5 sm:p-2 text-slate-400 hover:text-orange-600 hover:bg-orange-50 rounded-xl transition-colors"><Pencil className="w-3.5 h-3.5 sm:w-4 sm:h-4" /></button>
                                                <button onClick={(e) => handleDeleteHalaqohReq(e, h)} className="p-1.5 sm:p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-xl transition-colors"><Trash2 className="w-3.5 h-3.5 sm:w-4 sm:h-4" /></button>
                                            </>
                                        ) : (
                                            <div className="p-1.5 sm:p-2 flex-shrink-0 cursor-pointer pointer-events-none"><ArrowRight className="w-4 h-4 sm:w-5 sm:h-5 text-slate-300 group-hover:text-orange-500 transition-all group-hover:translate-x-1" /></div>
                                        )}
                                    </div>
                                </div>
                                <div className="h-px w-full bg-slate-50 my-2 sm:my-3"></div>
                                <div className="flex flex-wrap gap-1.5 sm:gap-2">
                                    {(Array.isArray(h?.students) ? h.students : []).length > 0 ? (
                                        h.students.map((cls, idx) => (
                                            <span key={idx} className="text-[9px] sm:text-[10px] font-medium text-slate-600 bg-slate-50 border border-slate-100 px-2 sm:px-2.5 py-1 sm:py-1.5 rounded-lg flex items-center gap-1 group-hover:border-orange-100 group-hover:bg-orange-50/50 transition-colors">
                                                <div className="w-1 sm:w-1.5 h-1 sm:h-1.5 rounded-full bg-orange-300"></div>{cls}
                                            </span>
                                        ))
                                    ) : (
                                        <span className="text-[9px] sm:text-[11px] text-slate-400 italic">Belum ada siswa</span>
                                    )}
                                </div>
                            </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </>
              )}

              {(currentView === 'home' || currentView === 'history' || currentView === 'leaderboard') && (
                <>
                  {HeaderUI(selectedHalaqoh?.name, selectedUstadz?.name)}
                  <div className="max-w-xl mx-auto p-3 sm:p-4">
                    <div className="flex bg-white p-1 rounded-xl shadow-sm mb-4 sm:mb-6 border border-slate-100">
                       <button onClick={() => setCurrentView('home')} className={`flex-1 py-1.5 sm:py-2 rounded-lg text-[10px] sm:text-xs md:text-sm font-bold ${currentView === 'home' ? 'bg-orange-600 text-white shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}>Input</button>
                       <button onClick={() => setCurrentView('history')} className={`flex-1 py-1.5 sm:py-2 rounded-lg text-[10px] sm:text-xs md:text-sm font-bold ${currentView === 'history' ? 'bg-orange-600 text-white shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}>Riwayat</button>
                       <button onClick={() => setCurrentView('leaderboard')} className={`flex-1 py-1.5 sm:py-2 rounded-lg text-[10px] sm:text-xs md:text-sm font-bold ${currentView === 'leaderboard' ? 'bg-orange-600 text-white shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}>Leaderboard</button>
                    </div>

                    {currentView === 'home' ? (
                      <div className="animate-in fade-in">
                         <div className="bg-orange-50 p-2.5 sm:p-3 rounded-xl border border-orange-100 mb-3 sm:mb-4 flex items-center justify-between text-xs sm:text-sm text-slate-600">
                            <span className="flex items-center gap-1.5 sm:gap-2 truncate mr-2"><FolderOpen className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-orange-500 flex-shrink-0" /> <span className="truncate">{selectedHalaqoh?.name || '-'}</span></span>
                            <span className="flex items-center gap-1.5 sm:gap-2 truncate"><User className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-orange-500 flex-shrink-0" /> <span className="truncate">{selectedUstadz?.name || '-'}</span></span>
                         </div>
                         <div className="flex flex-col sm:flex-row gap-2.5 sm:gap-3 mb-3 sm:mb-4">
                            <div className="bg-white p-3 sm:p-4 rounded-2xl shadow-sm border border-orange-100 flex-1 w-full">
                                <label className="text-[9px] sm:text-[10px] font-bold text-slate-400 uppercase mb-1 block">Pilih Siswa</label>
                                <div className="relative">
                                   <select value={selectedStudent || ''} onChange={(e) => setSelectedStudent(e.target.value)} className={`w-full appearance-none font-bold p-2.5 sm:p-3 pr-8 sm:pr-10 truncate rounded-xl border focus:outline-none cursor-pointer transition-colors text-xs sm:text-sm ${selectedStudent ? 'bg-orange-50 text-slate-700 border-orange-200 focus:border-orange-500' : 'bg-slate-50 text-slate-400 border-slate-200 focus:border-slate-400'}`}>
                                     <option value="" disabled>-- Pilih Siswa --</option>
                                     {(Array.isArray(selectedHalaqoh?.students) ? selectedHalaqoh.students : []).length > 0 ? selectedHalaqoh.students.map(s => <option key={s} value={s}>{s}</option>) : <option value="" disabled>Belum ada siswa</option>}
                                   </select>
                                   <ChevronDown className={`absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none w-3.5 h-3.5 sm:w-4 sm:h-4 ${selectedStudent ? 'text-orange-400' : 'text-slate-400'}`} />
                                </div>
                                <p className="text-[8px] sm:text-[9px] text-orange-500 italic mt-1.5 font-medium">*Maksimal input 1 kali sehari per siswa</p>
                                {isAdmin && (<button onClick={() => setShowManageStudentModal(true)} className="w-full mt-2 p-1.5 sm:p-2 bg-orange-50 text-orange-600 text-[10px] sm:text-xs font-bold rounded-lg hover:bg-orange-100 flex items-center justify-center gap-1"><UserCog className="w-3 h-3 sm:w-4 sm:h-4" /> Kelola Siswa</button>)}
                            </div>
                            <div className="bg-white p-3 sm:p-4 rounded-2xl shadow-sm border border-orange-100 flex-1 w-full">
                                <label className="text-[9px] sm:text-[10px] font-bold text-slate-400 uppercase mb-1 block">Pilih Kelas</label>
                                <div className="relative">
                                   <select value={selectedClass || ''} onChange={(e) => setSelectedClass(e.target.value)} className={`w-full appearance-none font-bold p-2.5 sm:p-3 pr-8 sm:pr-10 truncate rounded-xl border focus:outline-none cursor-pointer transition-colors text-xs sm:text-sm ${selectedClass ? 'bg-orange-50 text-slate-700 border-orange-200 focus:border-orange-500' : 'bg-slate-50 text-slate-400 border-slate-200 focus:border-slate-400'}`}>
                                     <option value="" disabled>-- Pilih Kelas --</option>
                                     {(Array.isArray(classes) ? classes : []).map(c => <option key={c} value={c}>{c}</option>)}
                                   </select>
                                   <ChevronDown className={`absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none w-3.5 h-3.5 sm:w-4 sm:h-4 ${selectedClass ? 'text-orange-400' : 'text-slate-400'}`} />
                                </div>
                            </div>
                         </div>
                         <div className="relative mb-3 sm:mb-4">
                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4 sm:w-4 sm:h-4" />
                            <input type="text" placeholder="Cari surat..." className="w-full pl-8 sm:pl-9 pr-3 sm:pr-4 py-2.5 sm:py-3 rounded-xl border border-orange-100 shadow-sm outline-none text-xs sm:text-sm focus:border-orange-400 transition-all" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                         </div>
                         <div className="grid grid-cols-2 gap-2 pb-24">
                            {filteredSurahs.map(surah => {
                              const safeSurahs = Array.isArray(selectedSurahs) ? selectedSurahs : [];
                              const isSel = safeSurahs.includes(surah.number);
                              const range = (selectedRanges || {})[surah.number];
                              return (
                                <button key={surah.number} onClick={() => toggleSurah(surah)} className={`p-2 sm:p-2.5 rounded-lg border text-left transition-all flex items-center justify-between ${isSel ? 'border-orange-500 bg-orange-50 shadow-sm ring-1 ring-orange-200' : 'border-slate-100 bg-white hover:border-orange-100 shadow-sm'}`}>
                                  <div className="flex-1 min-w-0">
                                      <div className={`text-[10px] sm:text-xs md:text-sm font-bold truncate ${isSel ? 'text-orange-900' : 'text-slate-700'}`}>{surah.number}. {surah.name} <span className="font-normal text-slate-400 text-[9px] sm:text-[10px]">({surah.ayahs})</span></div>
                                      {range && <div className="text-[8px] sm:text-[9px] md:text-[10px] text-orange-600 font-bold uppercase leading-none mt-0.5 sm:mt-1">{range}</div>}
                                  </div>
                                  {isSel && <Check className="w-3 h-3 sm:w-3.5 sm:h-3.5 text-orange-600 flex-shrink-0 ml-1" />}
                                </button>
                              );
                            })}
                         </div>
                         {(Array.isArray(selectedSurahs) && selectedSurahs.length > 0) && (
                           <div className="fixed bottom-20 left-0 right-0 p-3 sm:p-4 max-w-xl mx-auto z-40">
                              <button onClick={handleSaveSession} disabled={isLoading} className={`w-full text-white py-3 sm:py-4 rounded-2xl font-bold shadow-xl flex items-center justify-center gap-2 transform transition-all text-sm sm:text-base ${isLoading ? 'bg-orange-400 cursor-not-allowed' : 'bg-orange-600 hover:bg-orange-700 active:scale-95'}`}>
                                {isLoading ? <Loader2 className="animate-spin w-4 h-4 sm:w-5 sm:h-5" /> : <Check className="w-4 h-4 sm:w-5 sm:h-5" />}
                                {isLoading ? 'Menyimpan...' : `Simpan (${selectedSurahs.length})`}
                              </button>
                           </div>
                         )}
                      </div>
                    ) : currentView === 'history' ? (
                      <div className="space-y-3 sm:space-y-4 animate-in fade-in">
                         <div className="flex flex-col sm:flex-row gap-2 mb-3">
                            <div className="bg-white p-2.5 sm:p-3 rounded-xl border shadow-sm flex items-center gap-2 flex-1">
                               <Filter className="text-orange-500 w-4 h-4 sm:w-[18px] sm:h-[18px] flex-shrink-0" />
                               <select value={historyFilter} onChange={(e) => { setHistoryFilter(e.target.value); setHistoryPage(1); }} className="bg-transparent font-bold text-slate-600 w-full outline-none text-xs sm:text-sm">
                                  <option value="Semua">Semua Siswa</option>
                                  {(Array.isArray(selectedHalaqoh?.students) ? selectedHalaqoh.students : []).map(s => <option key={s} value={s}>{s}</option>)}
                               </select>
                            </div>
                            <div className="bg-white p-2.5 sm:p-3 rounded-xl border shadow-sm flex items-center gap-2 flex-1">
                               <Calendar className="text-orange-500 w-4 h-4 sm:w-[18px] sm:h-[18px] flex-shrink-0" />
                               <input type="date" value={historyDateFilter} onChange={(e) => { setHistoryDateFilter(e.target.value); setHistoryPage(1); }} className="bg-transparent font-bold text-slate-600 w-full outline-none text-xs sm:text-sm cursor-pointer" />
                               {historyDateFilter && (<button onClick={() => { setHistoryDateFilter(""); setHistoryPage(1); }} className="text-slate-400 hover:text-red-500 flex-shrink-0 transition-colors" title="Hapus Filter Tanggal"><X className="w-4 h-4 sm:w-5 sm:h-5" /></button>)}
                            </div>
                         </div>
                         {(() => {
                            const filteredHistory = (Array.isArray(history) ? history : []).filter(item => {
                                if (!item) return false;
                                const isCurrentHalaqoh = item?.halaqohName === selectedHalaqoh?.name && item?.ustadzName === selectedUstadz?.name;
                                const isMatchStudent = historyFilter === "Semua" ? true : item?.student === historyFilter;
                                const isMatchDate = historyDateFilter ? getLocalDateString(item?.date) === historyDateFilter : true;
                                return isCurrentHalaqoh && isMatchStudent && isMatchDate;
                            });
                            const totalPages = Math.ceil(filteredHistory.length / 10);
                            const displayedHistory = filteredHistory.slice((historyPage - 1) * 10, historyPage * 10);

                            if (filteredHistory.length === 0) return <div className="text-center py-8 text-slate-400 text-xs sm:text-sm">Belum ada riwayat pada tanggal/siswa ini.</div>;
                            return (
                               <>
                                 {displayedHistory.map(item => (
                                    <div key={item?.id || Math.random()} className="bg-white p-4 sm:p-5 rounded-2xl shadow-sm border">
                                       <div className="flex justify-between border-b pb-2 sm:pb-3 mb-2 sm:mb-3">
                                          <div className="flex-1 overflow-hidden">
                                            <div className="flex items-center gap-1.5 sm:gap-2 mb-1">
                                               <span className="font-bold text-slate-800 text-sm sm:text-base md:text-lg truncate">{item?.student || '-'}</span>
                                               <span className="text-[8px] sm:text-[9px] md:text-[10px] bg-slate-100 text-slate-500 px-1.5 sm:px-2 py-0.5 rounded font-bold uppercase flex-shrink-0">{item?.class || '-'}</span>
                                            </div>
                                            <div className="text-[10px] sm:text-xs text-slate-500 flex flex-col gap-0.5 sm:gap-1 mt-1">
                                                <div className="flex items-center gap-1 truncate"><FolderOpen className="w-3 h-3 text-orange-400 flex-shrink-0" /> <span className="truncate">{item?.halaqohName || '-'}</span></div>
                                                <div className="flex items-center gap-1 truncate"><User className="w-3 h-3 text-orange-400 flex-shrink-0" /> <span className="truncate">{item?.ustadzName || '-'}</span></div>
                                            </div>
                                          </div>
                                          <div className="flex gap-1 sm:gap-2 flex-shrink-0 pl-2">
                                              <button onClick={() => handleShareClick(item)} className="p-1 text-slate-300 hover:text-blue-500 transition-colors" title="Bagikan Gambar"><ImageIcon className="w-3.5 h-3.5 sm:w-4 sm:h-4" /></button>
                                              {isAdmin && (
                                                <>
                                                    <button onClick={() => { setEditingHistoryItem(item); setShowEditHistoryModal(true); }} className="p-1 text-slate-300 hover:text-orange-500 transition-colors" title="Edit Riwayat"><Edit2 className="w-3.5 h-3.5 sm:w-4 sm:h-4" /></button>
                                                    <button onClick={() => setDeleteConfig({show: true, type: 'history', id: item?.id})} className="p-1 text-slate-200 hover:text-red-500 transition-colors" title="Hapus Riwayat"><Trash2 className="w-3.5 h-3.5 sm:w-4 sm:h-4"/></button>
                                                </>
                                              )}
                                          </div>
                                       </div>
                                       <div className="flex flex-wrap gap-1.5 sm:gap-2">
                                          {(Array.isArray(item?.surahs) ? item.surahs : []).map(num => {
                                            const surahName = getSurahName(num);
                                            const range = item?.ranges?.[num] ? item.ranges[num] : null;
                                            return (<span key={num} className="bg-orange-50 text-orange-700 px-2 sm:px-3 py-1 rounded-lg text-[9px] sm:text-[10px] font-bold border border-orange-100 leading-tight">{surahName} {range ? <span className="text-orange-500 text-[8px] sm:text-[9px] ml-0.5 sm:ml-1">({range})</span> : ''}</span>);
                                          })}
                                       </div>
                                       <div className="text-[8px] sm:text-[9px] text-slate-300 mt-2 sm:mt-3 uppercase tracking-wider flex items-center gap-1"><Calendar className="w-2.5 h-2.5 sm:w-3 sm:h-3" /> {getFormattedDate(item?.date || new Date().toISOString())}</div>
                                       {isAdmin && (item?.ipAddress || item?.userAgent) && (
                                          <div className="mt-3 pt-2 border-t border-slate-100 flex flex-col gap-1">
                                             <div className="flex items-start gap-1.5 text-[9px] text-slate-400"><Globe className="w-3 h-3 flex-shrink-0 text-blue-400" /> <span className="break-all font-mono">IP: {item?.ipAddress || 'Unknown'}</span></div>
                                             <div className="flex items-start gap-1.5 text-[9px] text-slate-400"><Smartphone className="w-3 h-3 flex-shrink-0 text-purple-400" /> <span className="break-all line-clamp-2" title={item?.userAgent}>{item?.userAgent || 'Unknown Device'}</span></div>
                                          </div>
                                       )}
                                    </div>
                                 ))}
                                 {totalPages > 1 && (
                                    <div className="flex justify-center items-center gap-3 pt-4 pb-2">
                                       <button onClick={() => setHistoryPage(p => Math.max(1, p - 1))} disabled={historyPage === 1} className="p-2 bg-white rounded-xl shadow-sm border border-slate-200 disabled:opacity-40 text-orange-600 hover:bg-orange-50 transition-colors"><ArrowLeft className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                                       <span className="text-[10px] sm:text-xs font-bold text-slate-500 px-4">Hal {historyPage} dari {totalPages}</span>
                                       <button onClick={() => setHistoryPage(p => Math.min(totalPages, p + 1))} disabled={historyPage === totalPages} className="p-2 bg-white rounded-xl shadow-sm border border-slate-200 disabled:opacity-40 text-orange-600 hover:bg-orange-50 transition-colors"><ArrowRight className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                                    </div>
                                 )}
                               </>
                            );
                         })()}
                      </div>
                    ) : currentView === 'leaderboard' ? (
                      <div className="space-y-3 sm:space-y-4 animate-in fade-in">
                         <div className="bg-gradient-to-br from-yellow-500 to-amber-600 p-4 sm:p-5 rounded-2xl shadow-lg text-white mb-2 relative overflow-hidden">
                             {/* Gambar Quran Transparan di Latar Belakang */}
                             <img src="https://cdn-icons-png.flaticon.com/512/9960/9960186.png" alt="Quran Background" className="absolute right-[-10px] bottom-[-20px] w-32 h-32 opacity-25 object-contain drop-shadow-md" />
                             
                             {/* Judul Papan Peringkat dengan Ikon Quran Kecil */}
                             <h3 className="font-bold text-lg sm:text-xl relative z-10 flex items-center gap-2">
                                <img src="https://cdn-icons-png.flaticon.com/512/9960/9960186.png" alt="Quran Icon" className="w-5 h-5 sm:w-6 sm:h-6 object-contain drop-shadow-sm" /> 
                                Papan Peringkat
                             </h3>
                             <p className="text-[10px] sm:text-xs text-yellow-100 relative z-10 mt-0.5">Berdasarkan total surat yang disetorkan di Halaqoh ini.</p>
                         </div>
                         <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                             {halaqohLeaderboard.length === 0 ? (
                                <div className="text-center py-8 text-slate-400 text-xs sm:text-sm">Belum ada siswa di halaqoh ini.</div>
                             ) : (
                                halaqohLeaderboard.map((user, idx) => {
                                  let rankStyle = "bg-slate-100 text-slate-500"; let rowStyle = "border-b border-slate-50 last:border-0";
                                  if (idx === 0) rankStyle = "bg-yellow-400 text-yellow-900 ring-2 ring-yellow-200 shadow-sm"; else if (idx === 1) rankStyle = "bg-slate-300 text-slate-800 shadow-sm"; else if (idx === 2) rankStyle = "bg-amber-600 text-amber-50 shadow-sm";
                                  return (
                                      <div key={idx} className={`flex items-center justify-between p-3 sm:p-4 hover:bg-slate-50 transition-colors ${rowStyle}`}>
                                          <div className="flex items-center gap-3 sm:gap-4 flex-1 min-w-0">
                                             <div className={`w-7 h-7 sm:w-8 sm:h-8 flex items-center justify-center rounded-full text-xs sm:text-sm font-bold flex-shrink-0 ${rankStyle}`}>{idx + 1}</div>
                                             <div className="text-left flex-1 min-w-0">
                                                <div className="text-xs sm:text-sm md:text-base font-bold text-slate-800 truncate">{user?.student || '-'}</div>
                                                <div className="text-[9px] sm:text-[10px] text-slate-400 truncate">{user?.class !== '-' ? user.class : 'Belum ada setoran'}</div>
                                             </div>
                                          </div>
                                          <div className="text-right flex flex-col justify-center flex-shrink-0 pl-3">
                                             <div className="text-xs sm:text-sm font-black text-orange-600">{user?.surahCount || 0} Surat</div>
                                             <div className="text-[9px] sm:text-[10px] font-medium text-slate-400">{user?.sessionCount || 0} Setoran</div>
                                          </div>
                                      </div>
                                  )
                                })
                             )}
                         </div>
                      </div>
                    ) : null}
                  </div>
                </>
              )}

              {/* ADMIN DASHBOARD VIEW */}
              {currentView === 'admin-dashboard' && isAdmin && (
                <div className="min-h-screen bg-orange-50 text-slate-800 pb-24 relative">
                   {HeaderUI("Dashboard Admin", "Rekapitulasi Data Murojaah")}
                   <div className="max-w-xl mx-auto p-3 sm:p-4 animate-in fade-in slide-in-from-bottom-4 duration-300">
                      <div className="bg-gradient-to-r from-orange-500 to-red-600 rounded-2xl p-4 sm:p-5 text-white shadow-lg mb-4 sm:mb-6">
                         <div className="flex items-center gap-2 sm:gap-3 mb-1 sm:mb-2"><Star className="w-4 h-4 sm:w-5 sm:h-5 text-yellow-300 fill-yellow-300" /><h3 className="font-bold text-sm sm:text-base">Total Setoran Masuk</h3></div>
                         <div className="flex items-baseline gap-2"><span className="text-2xl sm:text-3xl font-bold">{(Array.isArray(history) ? history : []).length}</span><span className="text-orange-100 text-sm sm:text-base">Sesi</span></div>
                         <div className="mt-2 text-[9px] sm:text-xs bg-white/20 inline-block px-2 py-1 rounded-lg">Semua Data</div>
                      </div>
                      <div className="flex flex-col sm:flex-row gap-2 mb-3 sm:mb-4">
                          <div className="bg-white p-2.5 sm:p-3 rounded-xl border border-orange-100 shadow-sm flex items-center gap-2 flex-1">
                             <Search className="w-4 h-4 sm:w-5 sm:h-5 text-orange-400 flex-shrink-0" />
                             <input type="text" placeholder="Cari Siswa, Ustadz, dll..." className="w-full bg-transparent outline-none text-slate-700 font-medium text-xs sm:text-sm" value={adminSearchTerm} onChange={(e) => { setAdminSearchTerm(e.target.value); setAdminHistoryPage(1); }} />
                          </div>
                          <div className="bg-white p-2.5 sm:p-3 rounded-xl border border-orange-100 shadow-sm flex items-center gap-2 flex-1 sm:max-w-[200px]">
                             <Calendar className="w-4 h-4 sm:w-5 sm:h-5 text-orange-400 flex-shrink-0" />
                             <input type="date" value={adminHistoryDateFilter} onChange={(e) => { setAdminHistoryDateFilter(e.target.value); setAdminHistoryPage(1); }} className="w-full bg-transparent outline-none text-slate-700 font-medium text-xs sm:text-sm cursor-pointer" />
                             {adminHistoryDateFilter && (<button onClick={() => { setAdminHistoryDateFilter(""); setAdminHistoryPage(1); }} className="text-slate-400 hover:text-red-500 flex-shrink-0 transition-colors" title="Hapus Filter Tanggal"><X className="w-4 h-4 sm:w-5 sm:h-5" /></button>)}
                          </div>
                      </div>
                      <div className="space-y-3 sm:space-y-4">
                         {(!Array.isArray(history) || history.length === 0) ? <div className="text-center py-12 text-slate-400 text-xs sm:text-sm">Belum ada data masuk.</div> : (() => {
                            const filteredAdminHistory = history.filter(item => {
                                if (!item) return false;
                                const term = adminSearchTerm.toLowerCase();
                                const matchSearch = (item?.student || '').toLowerCase().includes(term) || (item?.ustadzName || '').toLowerCase().includes(term) || (item?.halaqohName || '').toLowerCase().includes(term) || (item?.class || '').toLowerCase().includes(term);
                                const matchDate = adminHistoryDateFilter ? getLocalDateString(item?.date) === adminHistoryDateFilter : true;
                                return matchSearch && matchDate;
                            });
                            const totalAdminPages = Math.ceil(filteredAdminHistory.length / 10);
                            const displayedAdminHistory = filteredAdminHistory.slice((adminHistoryPage - 1) * 10, adminHistoryPage * 10);

                            if (filteredAdminHistory.length === 0) return <div className="text-center py-8 text-slate-400 text-xs sm:text-sm">Data tidak ditemukan.</div>;

                            return (
                               <>
                                 {displayedAdminHistory.map((item) => (
                                   <div key={item?.id || Math.random()} className="bg-white p-4 sm:p-5 rounded-2xl shadow-sm border border-slate-100 relative group">
                                      <div className="flex justify-between items-start mb-2 sm:mb-3 border-b border-slate-50 pb-2 sm:pb-3">
                                         <div className="flex-1 overflow-hidden">
                                            <div className="flex items-center gap-1.5 sm:gap-2 mb-1">
                                               <User className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-orange-600 flex-shrink-0" />
                                               <span className="font-bold text-slate-800 text-sm sm:text-base md:text-lg truncate">{item?.student || '-'}</span>
                                               <span className="text-[8px] sm:text-[10px] bg-slate-100 text-slate-500 px-1.5 sm:px-2 py-0.5 rounded font-bold uppercase flex-shrink-0">{item?.class || '-'}</span>
                                            </div>
                                            <div className="text-[10px] sm:text-xs text-slate-400 flex flex-col gap-0.5 sm:gap-1">
                                               <span className="flex items-center gap-1 truncate"><FolderOpen className="w-3 h-3 text-orange-400 flex-shrink-0" /> <span className="truncate">{item?.halaqohName || '-'}</span></span>
                                               <span className="flex items-center gap-1 truncate"><User className="w-3 h-3 text-orange-400 flex-shrink-0" /> <span className="truncate">{item?.ustadzName || '-'}</span></span>
                                            </div>
                                         </div>
                                          <div className="flex gap-1 sm:gap-2 flex-shrink-0 pl-2">
                                              <button onClick={() => handleShareClick(item)} className="p-1 text-slate-300 hover:text-blue-500 transition-colors" title="Bagikan Gambar"><ImageIcon className="w-3.5 h-3.5 sm:w-4 sm:h-4" /></button>
                                              <button onClick={() => { setEditingHistoryItem(item); setShowEditHistoryModal(true); }} className="p-1 text-slate-300 hover:text-orange-500 transition-colors" title="Edit Riwayat"><Edit2 className="w-3.5 h-3.5 sm:w-4 sm:h-4" /></button>
                                             <button onClick={() => setDeleteConfig({show: true, type: 'history', id: item?.id})} className="p-1 text-slate-200 hover:text-red-500 transition-colors" title="Hapus Riwayat"><Trash2 className="w-3.5 h-3.5 sm:w-4 sm:h-4" /></button>
                                          </div>
                                      </div>
                                      <div className="flex flex-wrap gap-1.5 sm:gap-2 mb-2 sm:mb-3">
                                         {(Array.isArray(item?.surahs) ? item.surahs : []).map(num => (
                                            <span key={num} className="bg-orange-50 text-orange-700 px-2 sm:px-2.5 py-1 rounded-lg text-[9px] sm:text-[10px] font-bold border border-orange-100 leading-tight">
                                               {getSurahName(num)} {item?.ranges?.[num] ? <span className="text-orange-500 text-[8px] sm:text-[9px] ml-0.5 sm:ml-1">({item.ranges[num]})</span> : ''}
                                            </span>
                                         ))}
                                      </div>
                                      <div className="text-[8px] sm:text-[10px] text-slate-300 uppercase tracking-wider flex items-center gap-1"><Calendar className="w-2.5 h-2.5 sm:w-3 sm:h-3" /> {getFormattedDate(item?.date || new Date().toISOString())}</div>
                                      {(item?.ipAddress || item?.userAgent) && (
                                         <div className="mt-3 pt-2 border-t border-slate-100 flex flex-col gap-1">
                                             <div className="flex items-start gap-1.5 text-[9px] text-slate-400"><Globe className="w-3 h-3 flex-shrink-0 text-blue-400" /> <span className="break-all font-mono">IP: {item?.ipAddress || 'Unknown'}</span></div>
                                             <div className="flex items-start gap-1.5 text-[9px] text-slate-400"><Smartphone className="w-3 h-3 flex-shrink-0 text-purple-400" /> <span className="break-all line-clamp-2" title={item?.userAgent}>{item?.userAgent || 'Unknown Device'}</span></div>
                                         </div>
                                      )}
                                   </div>
                                 ))}
                                 {totalAdminPages > 1 && (
                                    <div className="flex justify-center items-center gap-3 pt-4 pb-2">
                                       <button onClick={() => setAdminHistoryPage(p => Math.max(1, p - 1))} disabled={adminHistoryPage === 1} className="p-2 bg-white rounded-xl shadow-sm border border-slate-200 disabled:opacity-40 text-orange-600 hover:bg-orange-50 transition-colors"><ArrowLeft className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                                       <span className="text-[10px] sm:text-xs font-bold text-slate-500 px-4">Hal {adminHistoryPage} dari {totalAdminPages}</span>
                                       <button onClick={() => setAdminHistoryPage(p => Math.min(totalAdminPages, p + 1))} disabled={adminHistoryPage === totalAdminPages} className="p-2 bg-white rounded-xl shadow-sm border border-slate-200 disabled:opacity-40 text-orange-600 hover:bg-orange-50 transition-colors"><ArrowRight className="w-4 h-4 sm:w-5 sm:h-5" /></button>
                                    </div>
                                 )}
                               </>
                            );
                         })()}
                      </div>
                   </div>
                </div>
              )}
              
              {showConfetti && (
                <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/40 backdrop-blur-sm">
                   <div className="bg-white p-8 sm:p-10 rounded-[3rem] shadow-2xl text-center transform scale-110 mx-4">
                      <div className="w-20 h-20 sm:w-24 sm:h-24 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 sm:mb-6"><BookOpen className="text-orange-600 animate-bounce w-10 h-10 sm:w-12 sm:h-12" /></div>
                      <h3 className="text-2xl sm:text-3xl font-bold mb-2 italic">Alhamdulillah!</h3>
                      <p className="text-sm sm:text-base text-slate-500">Data hafalan tersimpan.</p>
                   </div>
                </div>
              )}

              <footer className="w-full text-center py-4 sm:py-6 text-slate-400 text-[10px] sm:text-sm font-medium">&copy; 2026 Juman Jayyidin. All rights reserved.</footer>
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><MainApp /></ErrorBoundary>);
    </script>
</body>
</html>
